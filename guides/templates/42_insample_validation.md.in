# In-Sample Forecasts & Confidence Levels

## Overview

The forecasting API now returns **in-sample fitted values** and **confidence level metadata** for enhanced model diagnostics and transparency.

## New Output Fields

### 1. `insample_fitted` (DOUBLE[])

**Purpose**: Returns the model's fitted values on the training data (one-step-ahead predictions).

**Default**: Empty list (`[]`)

**When populated**: Set `return_insample: true` in parameters

**Use cases**:
- Residual analysis
- Model diagnostics
- Goodness-of-fit assessment
- Cross-validation
- Detect overfitting

**Example**:
<!-- include: test/sql/docs_examples/42_insample_validation_seasonality_01.sql -->

### 2. `confidence_level` (DOUBLE)

**Purpose**: Shows what confidence level was used for prediction intervals.

**Default**: `0.90` (90%)

**Range**: 0.0 to 1.0 (exclusive)

**Use cases**:
- Document interval interpretation
- Verify expected coverage
- Metadata for downstream analysis

**Example**:
<!-- include: test/sql/docs_examples/42_insample_validation_example_02.sql -->

---

## Parameters

### `return_insample` (BOOLEAN)

**Purpose**: Control whether to return fitted values.

**Default**: `false`

**Performance**: Minimal overhead (~1-2%) when enabled.

**Example**:
<!-- include: test/sql/docs_examples/42_insample_validation_example_03.sql -->

### `confidence_level` (DOUBLE)

**Purpose**: Set the confidence level for prediction intervals.

**Default**: `0.90` (90% confidence intervals)

**Valid range**: `0.0 < level < 1.0`

**Common values**:
- `0.80` - 80% CI (narrow, frequent misses)
- `0.90` - 90% CI (default, balanced)
- `0.95` - 95% CI (wide, standard)
- `0.99` - 99% CI (very wide, conservative)

**Example**:
<!-- include: test/sql/docs_examples/42_insample_validation_example_04.sql -->

---

## Complete Examples

### Example 1: Model Diagnostics with Residuals

<!-- include: test/sql/docs_examples/42_insample_validation_complete_example_05.sql -->

### Example 2: Compare Multiple Confidence Levels

<!-- include: test/sql/docs_examples/42_insample_validation_example_06.sql -->

### Example 3: Goodness-of-Fit Analysis

<!-- include: test/sql/docs_examples/42_insample_validation_example_07.sql -->

### Example 4: Cross-Validation with Fitted Values

<!-- include: test/sql/docs_examples/42_insample_validation_example_08.sql -->

### Example 5: GROUP BY with In-Sample Analysis

<!-- include: test/sql/docs_examples/42_insample_validation_example_09.sql -->

### Example 6: Detect Overfitting

<!-- include: test/sql/docs_examples/42_insample_validation_data_quality_10.sql -->

---

## Model Support for Fitted Values

### ‚úÖ Supported Models (23)

Models that return fitted values when `return_insample: true`:

- Naive, SeasonalNaive, RandomWalkWithDrift
- SESOptimized
- HoltWinters
- Theta, OptimizedTheta, DynamicTheta, DynamicOptimizedTheta
- SeasonalExponentialSmoothing, SeasonalESOptimized, SeasonalWindowAverage
- ETS, AutoETS
- AutoARIMA
- MFLES
- TBATS
- CrostonClassic, CrostonOptimized
- ADIDA, IMAPA, TSB

### ‚ö†Ô∏è Limited Support

Some models may return empty fitted values:
- SimpleMovingAverage (only provides fitted after warmup)
- Ensemble models (composite fittin)
- Some intermittent demand models

### üìù Checking Support

<!-- include: test/sql/docs_examples/42_insample_validation_example_11.sql -->

---

## Performance Impact

| Feature | Overhead | Notes |
|---------|----------|-------|
| `return_insample: false` (default) | 0% | No overhead |
| `return_insample: true` | ~1-2% | Minimal - fitted values computed during fit() |
| `confidence_level` | 0% | No overhead, only affects interval width |

**Recommendation**: Enable `return_insample` only when needed for diagnostics.

---

## Best Practices

### 1. Model Validation
<!-- include: test/sql/docs_examples/42_insample_validation_example_12.sql -->

### 2. Confidence Level Selection
<!-- include: test/sql/docs_examples/42_insample_validation_example_13.sql -->

### 3. Residual Monitoring
<!-- include: test/sql/docs_examples/42_insample_validation_example_14.sql -->

---

## API Summary

### Single Series
<!-- include: test/sql/docs_examples/42_insample_validation_example_15.sql -->

### Multiple Series
<!-- include: test/sql/docs_examples/42_insample_validation_multi_series_16.sql -->

### Output Schema
```
forecast_step: INT
date_col: TIMESTAMP
point_forecast: DOUBLE
lower: DOUBLE
upper: DOUBLE
model_name: VARCHAR
insample_fitted: DOUBLE[]        ‚Üê NEW
confidence_level: DOUBLE         ‚Üê NEW
```

---

## See Also

- **Model Selection**: docs/MODELS.md
- **Evaluation Metrics**: docs/50_evaluation_metrics.md (incl. TS_COVERAGE)
- **Examples**: examples/rolling_forecast.sql
- **API Reference**: 00_README.md

---

**Status**: ‚úÖ Production-ready

Both features are fully tested and integrated across all forecast functions!

