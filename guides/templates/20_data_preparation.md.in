# EDA & Data Preparation for Time Series

## Overview

Comprehensive SQL-based tools for time series EDA (Exploratory Data Analysis) and data preparation using DuckDB's powerful analytical capabilities.

**Key Features**:
- ✅ Zero Python dependencies - Pure SQL
- ✅ Leverages DuckDB's analytical functions
- ✅ Parallel processing out-of-the-box
- ✅ Memory-efficient operations
- ✅ Composable macros for pipelines

---

## Quick Start

<!-- include: test/sql/docs_examples/20_data_preparation_example_01.sql -->

---

## Part 1: EDA (Exploratory Data Analysis)

### 1.1 Per-Series Statistics

**Macro**: `TS_STATS(table_name, group_cols, date_col, value_col)`

Computes comprehensive statistics for each time series.

**Returns**:
- `series_id` - Series identifier
- `length` - Number of observations
- `expected_length` - Expected observations (based on date range)
- `n_gaps` - Missing time points
- `start_date`, `end_date` - Temporal span
- `mean`, `std`, `min`, `max`, `median` - Basic statistics
- `n_null`, `n_nan`, `n_zeros` - Missing/special values
- `n_unique_values` - Distinct values
- `is_constant` - Boolean flag for constant series
- `trend_corr` - Trend correlation (-1 to 1)
- `cv` - Coefficient of variation
- `intermittency` - Proportion of zeros
- `quality_score` - Overall quality (0-1, higher is better)
- `values`, `dates` - Raw data arrays

**Example**:
<!-- include: test/sql/docs_examples/20_data_preparation_data_quality_02.sql -->

### 1.2 Data Quality Checks

**Individual Checks**:
- `TS_CHECK_GAPS(stats_table)` - Gap analysis
- `TS_CHECK_MISSING(stats_table)` - NULL/NaN values
- `TS_CHECK_CONSTANT(stats_table)` - Constant series
- `TS_CHECK_SHORT(stats_table, min_length)` - Short series
- `TS_CHECK_ALIGNMENT(stats_table)` - End date alignment

**Comprehensive Report**:
<!-- include: test/sql/docs_examples/20_data_preparation_data_quality_03.sql -->

### 1.3 Pattern Detection

**Leading/Trailing Zeros**:
<!-- include: test/sql/docs_examples/20_data_preparation_seasonality_04.sql -->

**Plateau Detection** (consecutive identical values):
<!-- include: test/sql/docs_examples/20_data_preparation_seasonality_05.sql -->

### 1.4 Seasonality Detection

<!-- include: test/sql/docs_examples/20_data_preparation_seasonality_06.sql -->

### 1.5 Distribution Analysis

<!-- include: test/sql/docs_examples/20_data_preparation_seasonality_07.sql -->

### 1.6 Dataset Summary

<!-- include: test/sql/docs_examples/20_data_preparation_example_08.sql -->

---

## Part 2: Data Preparation

### 2.1 Fill Time Gaps

**Fill missing dates in time series**:
<!-- include: test/sql/docs_examples/20_data_preparation_data_quality_09.sql -->

### 2.2 Fill Forward to Date

**Extend all series to a common end date**:
<!-- include: test/sql/docs_examples/20_data_preparation_fill_gaps_10.sql -->

### 2.3 Drop Series by Criteria

**Drop constant series**:
<!-- include: test/sql/docs_examples/20_data_preparation_create_sample_data_11.sql -->

**Drop short series**:
<!-- include: test/sql/docs_examples/20_data_preparation_create_sample_data_12.sql -->

**Drop series with excessive gaps**:
<!-- include: test/sql/docs_examples/20_data_preparation_create_sample_data_13.sql -->

### 2.4 Remove Edge Zeros

**Drop leading zeros**:
<!-- include: test/sql/docs_examples/20_data_preparation_create_sample_data_14.sql -->

**Drop trailing zeros**:
<!-- include: test/sql/docs_examples/20_data_preparation_create_sample_data_15.sql -->

**Drop both**:
<!-- include: test/sql/docs_examples/20_data_preparation_create_sample_data_16.sql -->

### 2.5 Fill Missing Values

**Constant fill**:
<!-- include: test/sql/docs_examples/20_data_preparation_create_sample_data_17.sql -->

**Forward fill** (last observation carried forward):
<!-- include: test/sql/docs_examples/20_data_preparation_example_18.sql -->

**Backward fill** (next observation carried backward):
<!-- include: test/sql/docs_examples/20_data_preparation_example_19.sql -->

**Linear interpolation**:
<!-- include: test/sql/docs_examples/20_data_preparation_example_20.sql -->

**Fill with series mean**:
<!-- include: test/sql/docs_examples/20_data_preparation_example_21.sql -->

### 2.6 Outlier Treatment

**Cap outliers using IQR method**:
<!-- include: test/sql/docs_examples/20_data_preparation_example_22.sql -->

**Remove outliers using Z-score**:
<!-- include: test/sql/docs_examples/20_data_preparation_example_23.sql -->

### 2.7 Transformations

**Log transformation**:
<!-- include: test/sql/docs_examples/20_data_preparation_example_24.sql -->

**Box-Cox transformation**:
<!-- include: test/sql/docs_examples/20_data_preparation_example_25.sql -->

**Differencing**:
<!-- include: test/sql/docs_examples/20_data_preparation_example_26.sql -->

**Min-Max normalization** (per series):
<!-- include: test/sql/docs_examples/20_data_preparation_example_27.sql -->

**Standardization** (Z-score, per series):
<!-- include: test/sql/docs_examples/20_data_preparation_example_28.sql -->

### 2.8 Standard Pipeline

**All-in-one preparation**:
<!-- include: test/sql/docs_examples/20_data_preparation_example_29.sql -->

---

## Complete Workflow Example

<!-- include: test/sql/docs_examples/20_data_preparation_complete_example_30.sql -->

---

## Performance Tips

### 1. Use CTEs for Multi-Step Pipelines
<!-- include: test/sql/docs_examples/20_data_preparation_example_31.sql -->

### 2. Materialize Intermediate Results
<!-- include: test/sql/docs_examples/20_data_preparation_example_32.sql -->

### 3. Filter Early
<!-- include: test/sql/docs_examples/20_data_preparation_create_sample_data_33.sql -->

### 4. Use Parallel Processing
<!-- include: test/sql/docs_examples/20_data_preparation_statistics_34.sql -->

---

## Comparison: DuckDB SQL vs Python/Polars

| Feature | DuckDB SQL | Python/Polars |
|---------|------------|---------------|
| **Dependencies** | None | pandas/polars + anofox |
| **Parallelization** | Automatic | Manual threading |
| **Memory** | Optimized (columnar) | Depends on DataFrame |
| **Integration** | Native with forecasting | Requires data transfer |
| **Learning Curve** | Standard SQL | Library-specific API |
| **Portability** | Run anywhere (SQL) | Requires Python env |

---

## API Reference

### EDA Macros

| Macro | Description |
|-------|-------------|
| `TS_STATS` | Per-series comprehensive statistics |
| `TS_QUALITY_REPORT` | All quality checks in one report |
| `TS_CHECK_GAPS` | Gap analysis |
| `TS_CHECK_MISSING` | Missing value analysis |
| `TS_CHECK_CONSTANT` | Constant series detection |
| `TS_CHECK_SHORT` | Short series detection |
| `TS_CHECK_ALIGNMENT` | End date alignment |
| `TS_ANALYZE_ZEROS` | Leading/trailing zero analysis |
| `TS_DETECT_PLATEAUS` | Plateau detection |
| `TS_DETECT_SEASONALITY_ALL` | Seasonality detection |
| `TS_PERCENTILES` | Distribution percentiles |
| `TS_DATASET_SUMMARY` | Overall dataset statistics |
| `TS_GET_PROBLEMATIC` | Low-quality series |

### Data Preparation Macros

| Macro | Description |
|-------|-------------|
| `TS_FILL_GAPS` | Fill missing time gaps |
| `TS_FILL_FORWARD` | Extend series to date |
| `TS_DROP_CONSTANT` | Drop constant series |
| `TS_DROP_SHORT` | Drop short series |
| `TS_DROP_GAPPY` | Drop series with many gaps |
| `TS_DROP_LEADING_ZEROS` | Remove leading zeros |
| `TS_DROP_TRAILING_ZEROS` | Remove trailing zeros |
| `TS_DROP_EDGE_ZEROS` | Remove both edge zeros |
| `TS_FILL_NULLS_CONST` | Fill with constant |
| `TS_FILL_NULLS_FORWARD` | Forward fill |
| `TS_FILL_NULLS_BACKWARD` | Backward fill |
| `TS_FILL_NULLS_INTERPOLATE` | Linear interpolation |
| `TS_FILL_NULLS_MEAN` | Fill with series mean |
| `TS_CAP_OUTLIERS_IQR` | Cap outliers (IQR) |
| `TS_REMOVE_OUTLIERS_ZSCORE` | Remove outliers (Z-score) |
| `TS_TRANSFORM_LOG` | Log transformation |
| `TS_TRANSFORM_BOXCOX` | Box-Cox transformation |
| `TS_DIFF` | Differencing |
| `TS_NORMALIZE_MINMAX` | Min-Max normalization |
| `TS_STANDARDIZE` | Z-score standardization |
| `TS_PREPARE_STANDARD` | Standard pipeline |

---

## Status

✅ **Production-ready**

All macros are tested and ready for use with DuckDB 1.4.1+

---

## See Also

- **Forecasting**: `00_README.md`, `docs/42_insample_validation.md`
- **Metrics**: `docs/50_evaluation_metrics.md`
- **Examples**: `examples/eda_data_prep_demo.sql`

