-- This script compares time series features computed using DuckDB's ts_features table function
-- with those generated by the tsfresh Python library on identical datasets.
--
-- Workflow:
--   1. Loads parquet files containing features exported from DuckDB (anofox_features.parquet)
--      and Python (tsfresh_results.parquet), each containing per-series feature columns.
--   2. Unpivots both tables into long format (one row per unique_id, feature) for comparison.
--   3. Joins on unique_id and feature_name to align corresponding features.
--   4. Computes absolute differences and summarizes maximum and average errors per feature.
--
-- Output: A table showing, for each feature, the maximum and average difference,
--         plus count of series where the values do not match exactly.



CREATE OR REPLACE TABLE ts_features_tsfresh AS (
    SELECT * FROM read_parquet('data/tsfresh_results.parquet')
);

CREATE OR REPLACE TABLE ts_features_duckdb AS (
    SELECT * FROM read_parquet('data/anofox_features.parquet')
);


-- Compare results
WITH tsfresh_long AS (
    SELECT
        unique_id,
        REGEXP_REPLACE(t_column, '^value__', '') AS feature_name,
        tsfresh_value
    FROM ts_features_tsfresh
    UNPIVOT (tsfresh_value FOR t_column IN (COLUMNS('value__*')))
),
duckdb_long AS (
    SELECT
        unique_id,
        d_column AS feature_name,
        duckdb_value
    FROM ts_features_duckdb
    UNPIVOT (duckdb_value FOR d_column IN (COLUMNS(* EXCLUDE (unique_id))))
),
joined AS (
    SELECT
        d.unique_id,
        d.feature_name,
        d.duckdb_value,
        t.tsfresh_value,
        ABS(d.duckdb_value - t.tsfresh_value) AS abs_diff
    FROM duckdb_long d
    JOIN tsfresh_long t
        ON d.unique_id = t.unique_id
       AND d.feature_name = t.feature_name
)
SELECT
    feature_name,
    MAX(abs_diff) AS max_abs_diff,
    AVG(abs_diff) AS avg_abs_diff,
    COUNT(*) FILTER (WHERE abs_diff > 1e-9) AS mismatched_rows
FROM joined
GROUP BY feature_name
ORDER BY feature_name;