# name: test/sql/ts_backtest_regression.test
# description: Tests for ts_backtest_regression - OLS regression backtest
# group: [sql]

require anofox_forecast

#######################################
# Setup Test Data
#######################################

statement ok
CREATE TABLE regression_data AS
SELECT
    series_id,
    '2024-01-01'::DATE + (i * INTERVAL '1 day') AS date,
    10.0 + i * 2.0 + (CASE WHEN series_id = 'A' THEN 50 ELSE 0 END) AS revenue,
    i AS day_index
FROM generate_series(0, 59) AS t(i)
CROSS JOIN (SELECT UNNEST(['A', 'B']) AS series_id) s;

statement ok
CREATE TABLE cv_splits AS
SELECT * FROM ts_cv_split(
    'regression_data', series_id, date, revenue,
    ['2024-01-30'::DATE, '2024-02-15'::DATE], 7, '1d', MAP{}
);

#######################################
# ts_backtest_regression - Basic Tests
#######################################

# Test returns rows
query I
SELECT COUNT(*) FROM ts_backtest_regression(
    'cv_splits', 'regression_data', series_id, date, revenue, day_index, MAP{}
);
----
28

# Test returns correct columns
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM ts_backtest_regression(
        'cv_splits', 'regression_data', series_id, date, revenue, day_index, MAP{}
    )
);
----
9

# Test all folds are represented
query I
SELECT COUNT(DISTINCT fold_id) FROM ts_backtest_regression(
    'cv_splits', 'regression_data', series_id, date, revenue, day_index, MAP{}
);
----
2

# Test all series are represented per fold
query II
SELECT fold_id, COUNT(DISTINCT group_col) FROM ts_backtest_regression(
    'cv_splits', 'regression_data', series_id, date, revenue, day_index, MAP{}
)
GROUP BY fold_id ORDER BY fold_id;
----
1	2
2	2

#######################################
# ts_backtest_regression - Prediction Quality
#######################################

# Test predictions produce reasonable error (not perfect due to multi-series global fit)
# Note: OLS fits globally per fold, so different series offsets cause some error
query I
SELECT AVG(abs_error) < 50 FROM ts_backtest_regression(
    'cv_splits', 'regression_data', series_id, date, revenue, day_index, MAP{}
);
----
1

# Test fold_metric_score is computed
query I
SELECT COUNT(*) FROM ts_backtest_regression(
    'cv_splits', 'regression_data', series_id, date, revenue, day_index, MAP{}
) WHERE fold_metric_score IS NOT NULL;
----
28

#######################################
# ts_backtest_regression - Metric Parameter
#######################################

# Test metric='mae' works
query I
SELECT COUNT(*) FROM ts_backtest_regression(
    'cv_splits', 'regression_data', series_id, date, revenue, day_index, MAP{},
    metric => 'mae'
);
----
28

# Test model_name is set
query I
SELECT DISTINCT model_name FROM ts_backtest_regression(
    'cv_splits', 'regression_data', series_id, date, revenue, day_index, MAP{}
);
----
LinearRegression_OLS

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE regression_data;

statement ok
DROP TABLE cv_splits;
