# name: test/sql/features/test_confidence_level.test
# description: Test confidence level functionality
# group: [features]

require anofox_forecast

statement ok
LOAD anofox_forecast;

# Create test data
statement ok
CREATE TABLE test_series AS 
SELECT 
    i AS idx,
    100.0 + i * 1.0 AS value
FROM generate_series(1, 30) t(i);

# Test: Default confidence level (should be 0.90)
query RRRR
SELECT 
    result.confidence_level,
    result.confidence_level >= 0.89,
    result.confidence_level <= 0.91,
    result.confidence_level = 0.90
FROM (SELECT TS_FORECAST(value, 'Naive', 5, NULL) AS result FROM test_series);
----
0.900000	true	true	true

# Test: Custom confidence level 0.95
query RRR
SELECT 
    result.confidence_level,
    result.confidence_level >= 0.94,
    result.confidence_level <= 0.96
FROM (SELECT TS_FORECAST(value, 'Naive', 5, {'confidence_level': 0.95}) AS result FROM test_series);
----
0.950000	true	true

# Test: Custom confidence level 0.80
query RRR
SELECT 
    result.confidence_level,
    result.confidence_level >= 0.79,
    result.confidence_level <= 0.81
FROM (SELECT TS_FORECAST(value, 'Naive', 5, {'confidence_level': 0.80}) AS result FROM test_series);
----
0.800000	true	true

# Test: Custom confidence level 0.99
query RRR
SELECT 
    result.confidence_level,
    result.confidence_level >= 0.98,
    result.confidence_level <= 1.0
FROM (SELECT TS_FORECAST(value, 'Naive', 5, {'confidence_level': 0.99}) AS result FROM test_series);
----
0.990000	true	true

# Test: Confidence level affects interval width
# Higher confidence = wider intervals
statement ok
CREATE TABLE interval_width_test AS
SELECT 
    0.80 AS conf_level,
    (SELECT TS_FORECAST(value, 'Naive', 5, {'confidence_level': 0.80}) FROM test_series) AS result
UNION ALL
SELECT 
    0.90 AS conf_level,
    (SELECT TS_FORECAST(value, 'Naive', 5, {'confidence_level': 0.90}) FROM test_series) AS result
UNION ALL
SELECT 
    0.95 AS conf_level,
    (SELECT TS_FORECAST(value, 'Naive', 5, {'confidence_level': 0.95}) FROM test_series) AS result;

# Calculate average interval width for each confidence level
statement ok
CREATE TABLE avg_widths AS
SELECT 
    conf_level,
    result.confidence_level,
    AVG(result.upper[i] - result.lower[i]) AS avg_width
FROM interval_width_test
CROSS JOIN generate_series(1, 5) t(i)
GROUP BY conf_level, result.confidence_level
ORDER BY conf_level;

# Verify that higher confidence level produces wider intervals
# 0.95 width should be > 0.90 width should be > 0.80 width
query III
SELECT 
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.80) < 
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.90) AS test1,
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.90) < 
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.95) AS test2,
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.80) < 
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.95) AS test3;
----
true	true	true

# Test: Confidence level is consistent across different models
statement ok
CREATE TABLE multi_model_confidence AS
SELECT 
    'Naive' AS model,
    (SELECT TS_FORECAST(value, 'Naive', 5, {'confidence_level': 0.85}) FROM test_series) AS result
UNION ALL
SELECT 
    'SES' AS model,
    (SELECT TS_FORECAST(value, 'SES', 5, {'alpha': 0.3, 'confidence_level': 0.85}) FROM test_series) AS result
UNION ALL
SELECT 
    'AutoETS' AS model,
    (SELECT TS_FORECAST(value, 'AutoETS', 5, {'season_length': 1, 'confidence_level': 0.85}) FROM test_series) AS result;

# All models should return the same confidence level
query I
SELECT COUNT(DISTINCT result.confidence_level) = 1
FROM multi_model_confidence;
----
true

query R
SELECT DISTINCT result.confidence_level
FROM multi_model_confidence;
----
0.850000

# Test: Confidence level with in-sample forecasts
query RRI
SELECT 
    result.confidence_level,
    result.confidence_level = 0.92,
    len(result.insample_fitted) = 30
FROM (SELECT TS_FORECAST(value, 'Naive', 5, {'confidence_level': 0.92, 'return_insample': true}) AS result FROM test_series);
----
0.920000	true	true

# Cleanup
statement ok
DROP TABLE test_series;

statement ok
DROP TABLE interval_width_test;

statement ok
DROP TABLE avg_widths;

statement ok
DROP TABLE multi_model_confidence;

