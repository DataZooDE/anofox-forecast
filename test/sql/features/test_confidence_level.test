# name: test/sql/features/test_confidence_level.test
# description: Test confidence level functionality
# group: [features]

require anofox_forecast

statement ok
LOAD anofox_forecast;

# Create test data
statement ok
CREATE TABLE test_series AS 
SELECT 
    ('2024-01-01'::TIMESTAMP + INTERVAL (i) DAY) AS date_col,
    100.0 + i * 1.0 AS value
FROM generate_series(1, 30) t(i);

# Test: Default confidence level (should be 0.90)
statement ok
CREATE TABLE default_conf AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, NULL) AS result
FROM test_series;

query RRRR
SELECT 
    result.confidence_level,
    result.confidence_level >= 0.89,
    result.confidence_level <= 0.91,
    result.confidence_level = 0.90
FROM default_conf;
----
0.900000	true	true	true

# Test: Custom confidence level 0.95
statement ok
CREATE TABLE conf_95 AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'confidence_level': 0.95}) AS result
FROM test_series;

query RRR
SELECT 
    result.confidence_level,
    result.confidence_level >= 0.94,
    result.confidence_level <= 0.96
FROM conf_95;
----
0.950000	true	true

# Test: Custom confidence level 0.80
statement ok
CREATE TABLE conf_80 AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'confidence_level': 0.80}) AS result
FROM test_series;

query RRR
SELECT 
    result.confidence_level,
    result.confidence_level >= 0.79,
    result.confidence_level <= 0.81
FROM conf_80;
----
0.800000	true	true

# Test: Custom confidence level 0.99
statement ok
CREATE TABLE conf_99 AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'confidence_level': 0.99}) AS result
FROM test_series;

query RRR
SELECT 
    result.confidence_level,
    result.confidence_level >= 0.98,
    result.confidence_level <= 1.0
FROM conf_99;
----
0.990000	true	true

# Test: Confidence level affects interval width
# Higher confidence = wider intervals
statement ok
CREATE TABLE interval_widths AS
SELECT 
    0.80 AS conf_level,
    TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'confidence_level': 0.80}) AS result
FROM test_series
UNION ALL
SELECT 
    0.90 AS conf_level,
    TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'confidence_level': 0.90}) AS result
FROM test_series
UNION ALL
SELECT 
    0.95 AS conf_level,
    TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'confidence_level': 0.95}) AS result
FROM test_series;

# Calculate average interval width for each confidence level
statement ok
CREATE TABLE avg_widths AS
SELECT 
    conf_level,
    result.confidence_level,
    AVG(result.upper[i] - result.lower[i]) AS avg_width
FROM interval_widths
CROSS JOIN generate_series(1, 5) t(i)
GROUP BY conf_level, result.confidence_level
ORDER BY conf_level;

# Verify that higher confidence level produces wider intervals
query III
SELECT 
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.80) < 
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.90) AS test1,
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.90) < 
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.95) AS test2,
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.80) < 
    (SELECT avg_width FROM avg_widths WHERE conf_level = 0.95) AS test3;
----
true	true	true

# Test: Confidence level with table macro
statement ok
CREATE TABLE macro_conf AS
SELECT * FROM ts_forecast(test_series, date_col, value, 'Naive', 5, {'confidence_level': 0.85});

# Verify confidence level is exposed in macro
query R
SELECT DISTINCT confidence_level
FROM macro_conf;
----
0.850000

# Test: Confidence level with in-sample forecasts
statement ok
CREATE TABLE conf_with_insample AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'confidence_level': 0.92, 'return_insample': true}) AS result
FROM test_series;

query RRI
SELECT 
    result.confidence_level,
    result.confidence_level = 0.92,
    len(result.insample_fitted) = 30
FROM conf_with_insample;
----
0.920000	true	true

# Cleanup
statement ok
DROP TABLE test_series;

statement ok
DROP TABLE default_conf;

statement ok
DROP TABLE conf_95;

statement ok
DROP TABLE conf_80;

statement ok
DROP TABLE conf_99;

statement ok
DROP TABLE interval_widths;

statement ok
DROP TABLE avg_widths;

statement ok
DROP TABLE macro_conf;

statement ok
DROP TABLE conf_with_insample;
