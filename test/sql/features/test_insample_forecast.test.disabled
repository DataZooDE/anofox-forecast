# name: test/sql/features/test_insample_forecast.test
# description: Test in-sample fitted values functionality
# group: [features]

require anofox_forecast

statement ok
LOAD anofox_forecast;

# Create test data
statement ok
CREATE TABLE test_series AS 
SELECT 
    ('2024-01-01'::TIMESTAMP + INTERVAL (i) DAY) AS date_col,
    100.0 + i * 1.0 AS value
FROM generate_series(1, 20) t(i);

# Test: Default behavior (return_insample = false)
# insample_fitted should be empty
statement ok
CREATE TABLE default_result AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, NULL) AS result
FROM test_series;

query I
SELECT len(result.insample_fitted) = 0
FROM default_result;
----
true

# Test: With return_insample = true
# insample_fitted should have length equal to training data
statement ok
CREATE TABLE insample_result AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'return_insample': true}) AS result
FROM test_series;

query I
SELECT len(result.insample_fitted) = 20
FROM insample_result;
----
true

# Test: Naive model fitted values correctness
# For Naive, fitted[i] should equal actual[i-1]
statement ok
CREATE TABLE naive_test AS
SELECT 
    result.insample_fitted AS fitted,
    list(value) AS actual
FROM insample_result
CROSS JOIN (SELECT list(value ORDER BY date_col) AS value FROM test_series) t;

# Verify Naive fitted values: fitted[2] â‰ˆ actual[1]
# (allowing for small floating point differences)
query I
SELECT 
    fitted[2] >= actual[1] - 0.01 AND fitted[2] <= actual[1] + 0.01
FROM naive_test;
----
true

# Test: SES model returns fitted values
statement ok
CREATE TABLE ses_result AS
SELECT TS_FORECAST_AGG(date_col, value, 'SES', 5, {'alpha': 0.3, 'return_insample': true}) AS result
FROM test_series;

query I
SELECT len(result.insample_fitted) = 20
FROM ses_result;
----
true

# Test: AutoETS model returns fitted values
statement ok
CREATE TABLE ets_result AS
SELECT TS_FORECAST_AGG(date_col, value, 'AutoETS', 5, {'season_length': 1, 'return_insample': true}) AS result
FROM test_series;

query I
SELECT len(result.insample_fitted) = 20
FROM ets_result;
----
true

# Test: Verify fitted values are reasonable (not NULL, not inf)
query I
SELECT 
    result.insample_fitted[1] IS NOT NULL
    AND result.insample_fitted[1] < 1000000
    AND result.insample_fitted[1] > -1000000
FROM insample_result;
----
true

# Test: Table macro also exposes insample_fitted
statement ok
CREATE TABLE macro_result AS
SELECT * FROM ts_forecast(test_series, date_col, value, 'Naive', 5, {'return_insample': true});

# Verify insample_fitted is available in macro output
query I
SELECT insample_fitted IS NOT NULL AND len(insample_fitted) = 20
FROM macro_result
LIMIT 1;
----
true

# Cleanup
statement ok
DROP TABLE test_series;

statement ok
DROP TABLE default_result;

statement ok
DROP TABLE insample_result;

statement ok
DROP TABLE naive_test;

statement ok
DROP TABLE ses_result;

statement ok
DROP TABLE ets_result;

statement ok
DROP TABLE macro_result;
