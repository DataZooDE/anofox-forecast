# name: test/sql/ts_cv_generate_folds.test
# description: Tests for ts_cv_generate_folds - position-based fold boundary generation with type preservation
# group: [sql]

require anofox_forecast

#######################################
# Type Preservation Tests
# Verify output type matches input date column type
#######################################

# Test DATE type preservation
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES
        ('2023-01-01'), ('2023-02-01'), ('2023-03-01'), ('2023-04-01'),
        ('2023-05-01'), ('2023-06-01'), ('2023-07-01'), ('2023-08-01'),
        ('2023-09-01'), ('2023-10-01'), ('2023-11-01'), ('2023-12-01'),
        ('2024-01-01'), ('2024-02-01'), ('2024-03-01'), ('2024-04-01'),
        ('2024-05-01'), ('2024-06-01'), ('2024-07-01'), ('2024-08-01'),
        ('2024-09-01'), ('2024-10-01'), ('2024-11-01'), ('2024-12-01')
    ) AS t(d)
)
SELECT typeof(training_end_times) FROM ts_cv_generate_folds(data, ds, 2, 6, MAP{});
----
DATE[]

# Test TIMESTAMP type preservation
query I
WITH data AS (
    SELECT CAST(d AS TIMESTAMP) AS ds
    FROM (VALUES
        ('2023-01-01 00:00:00'), ('2023-02-01 00:00:00'), ('2023-03-01 00:00:00'),
        ('2023-04-01 00:00:00'), ('2023-05-01 00:00:00'), ('2023-06-01 00:00:00'),
        ('2023-07-01 00:00:00'), ('2023-08-01 00:00:00'), ('2023-09-01 00:00:00'),
        ('2023-10-01 00:00:00'), ('2023-11-01 00:00:00'), ('2023-12-01 00:00:00'),
        ('2024-01-01 00:00:00'), ('2024-02-01 00:00:00'), ('2024-03-01 00:00:00'),
        ('2024-04-01 00:00:00'), ('2024-05-01 00:00:00'), ('2024-06-01 00:00:00'),
        ('2024-07-01 00:00:00'), ('2024-08-01 00:00:00'), ('2024-09-01 00:00:00'),
        ('2024-10-01 00:00:00'), ('2024-11-01 00:00:00'), ('2024-12-01 00:00:00')
    ) AS t(d)
)
SELECT typeof(training_end_times) FROM ts_cv_generate_folds(data, ds, 2, 6, MAP{});
----
TIMESTAMP[]

# Test INTEGER type preservation (epoch days)
query I
WITH data AS (
    SELECT CAST(i AS INTEGER) AS ds
    FROM generate_series(1, 24) AS t(i)
)
SELECT typeof(training_end_times) FROM ts_cv_generate_folds(data, ds, 2, 6, MAP{});
----
INTEGER[]

# Test BIGINT type preservation (epoch seconds/microseconds)
query I
WITH data AS (
    SELECT CAST(i AS BIGINT) AS ds
    FROM generate_series(1, 24) AS t(i)
)
SELECT typeof(training_end_times) FROM ts_cv_generate_folds(data, ds, 2, 6, MAP{});
----
BIGINT[]

#######################################
# Fold Count Tests
# Verify correct number of folds returned
#######################################

# Test 1 fold
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES
        ('2023-01-01'), ('2023-02-01'), ('2023-03-01'), ('2023-04-01'),
        ('2023-05-01'), ('2023-06-01'), ('2023-07-01'), ('2023-08-01'),
        ('2023-09-01'), ('2023-10-01'), ('2023-11-01'), ('2023-12-01')
    ) AS t(d)
)
SELECT len(training_end_times) FROM ts_cv_generate_folds(data, ds, 1, 6, MAP{});
----
1

# Test 2 folds
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES
        ('2023-01-01'), ('2023-02-01'), ('2023-03-01'), ('2023-04-01'),
        ('2023-05-01'), ('2023-06-01'), ('2023-07-01'), ('2023-08-01'),
        ('2023-09-01'), ('2023-10-01'), ('2023-11-01'), ('2023-12-01'),
        ('2024-01-01'), ('2024-02-01'), ('2024-03-01'), ('2024-04-01'),
        ('2024-05-01'), ('2024-06-01'), ('2024-07-01'), ('2024-08-01'),
        ('2024-09-01'), ('2024-10-01'), ('2024-11-01'), ('2024-12-01')
    ) AS t(d)
)
SELECT len(training_end_times) FROM ts_cv_generate_folds(data, ds, 2, 6, MAP{});
----
2

# Test 3 folds
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES
        ('2023-01-01'), ('2023-02-01'), ('2023-03-01'), ('2023-04-01'),
        ('2023-05-01'), ('2023-06-01'), ('2023-07-01'), ('2023-08-01'),
        ('2023-09-01'), ('2023-10-01'), ('2023-11-01'), ('2023-12-01'),
        ('2024-01-01'), ('2024-02-01'), ('2024-03-01'), ('2024-04-01'),
        ('2024-05-01'), ('2024-06-01'), ('2024-07-01'), ('2024-08-01'),
        ('2024-09-01'), ('2024-10-01'), ('2024-11-01'), ('2024-12-01'),
        ('2025-01-01'), ('2025-02-01'), ('2025-03-01'), ('2025-04-01'),
        ('2025-05-01'), ('2025-06-01'), ('2025-07-01'), ('2025-08-01'),
        ('2025-09-01'), ('2025-10-01'), ('2025-11-01'), ('2025-12-01')
    ) AS t(d)
)
SELECT len(training_end_times) FROM ts_cv_generate_folds(data, ds, 3, 6, MAP{});
----
3

#######################################
# Fold Boundary Tests
# Verify folds are positioned at end of data (default behavior)
#######################################

# With 24 data points, horizon=6, folds=2:
# init_train_size = 24 - 2*6 = 12
# Fold 1: train ends at index 11 (month 12)
# Fold 2: train ends at index 17 (month 18)
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES
        ('2023-01-01'), ('2023-02-01'), ('2023-03-01'), ('2023-04-01'),
        ('2023-05-01'), ('2023-06-01'), ('2023-07-01'), ('2023-08-01'),
        ('2023-09-01'), ('2023-10-01'), ('2023-11-01'), ('2023-12-01'),
        ('2024-01-01'), ('2024-02-01'), ('2024-03-01'), ('2024-04-01'),
        ('2024-05-01'), ('2024-06-01'), ('2024-07-01'), ('2024-08-01'),
        ('2024-09-01'), ('2024-10-01'), ('2024-11-01'), ('2024-12-01')
    ) AS t(d)
)
SELECT training_end_times FROM ts_cv_generate_folds(data, ds, 2, 6, MAP{});
----
[2023-12-01, 2024-06-01]

#######################################
# Parameter Tests
#######################################

# Test initial_train_size parameter override
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES
        ('2023-01-01'), ('2023-02-01'), ('2023-03-01'), ('2023-04-01'),
        ('2023-05-01'), ('2023-06-01'), ('2023-07-01'), ('2023-08-01'),
        ('2023-09-01'), ('2023-10-01'), ('2023-11-01'), ('2023-12-01'),
        ('2024-01-01'), ('2024-02-01'), ('2024-03-01'), ('2024-04-01'),
        ('2024-05-01'), ('2024-06-01'), ('2024-07-01'), ('2024-08-01'),
        ('2024-09-01'), ('2024-10-01'), ('2024-11-01'), ('2024-12-01')
    ) AS t(d)
)
SELECT training_end_times FROM ts_cv_generate_folds(data, ds, 1, 6, MAP{'initial_train_size': 6});
----
[2023-06-01]

# Test skip_length parameter (controls spacing between folds)
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES
        ('2023-01-01'), ('2023-02-01'), ('2023-03-01'), ('2023-04-01'),
        ('2023-05-01'), ('2023-06-01'), ('2023-07-01'), ('2023-08-01'),
        ('2023-09-01'), ('2023-10-01'), ('2023-11-01'), ('2023-12-01'),
        ('2024-01-01'), ('2024-02-01'), ('2024-03-01'), ('2024-04-01'),
        ('2024-05-01'), ('2024-06-01'), ('2024-07-01'), ('2024-08-01'),
        ('2024-09-01'), ('2024-10-01'), ('2024-11-01'), ('2024-12-01')
    ) AS t(d)
)
SELECT training_end_times FROM ts_cv_generate_folds(data, ds, 3, 3, MAP{'initial_train_size': 6, 'skip_length': 3});
----
[2023-06-01, 2023-09-01, 2023-12-01]

#######################################
# Position-Based Indexing Tests
# Verify works with different "frequencies" (data spacing)
# No frequency parameter needed - uses position indices
#######################################

# Daily-like data (consecutive integers)
query I
WITH data AS (
    SELECT i AS ds FROM generate_series(1, 30) AS t(i)
)
SELECT len(training_end_times) FROM ts_cv_generate_folds(data, ds, 2, 10, MAP{});
----
2

# Weekly-like data (spacing of 7)
query I
WITH data AS (
    SELECT i * 7 AS ds FROM generate_series(1, 30) AS t(i)
)
SELECT len(training_end_times) FROM ts_cv_generate_folds(data, ds, 2, 10, MAP{});
----
2

# Monthly-like data (irregular spacing - calendar months)
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES
        ('2023-01-31'), ('2023-02-28'), ('2023-03-31'), ('2023-04-30'),
        ('2023-05-31'), ('2023-06-30'), ('2023-07-31'), ('2023-08-31'),
        ('2023-09-30'), ('2023-10-31'), ('2023-11-30'), ('2023-12-31'),
        ('2024-01-31'), ('2024-02-29'), ('2024-03-31'), ('2024-04-30'),
        ('2024-05-31'), ('2024-06-30'), ('2024-07-31'), ('2024-08-31'),
        ('2024-09-30'), ('2024-10-31'), ('2024-11-30'), ('2024-12-31')
    ) AS t(d)
)
SELECT len(training_end_times) FROM ts_cv_generate_folds(data, ds, 2, 6, MAP{});
----
2

#######################################
# Edge Cases
#######################################

# Minimum data - exactly enough for 1 fold with horizon 2
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES ('2023-01-01'), ('2023-02-01'), ('2023-03-01')) AS t(d)
)
SELECT len(training_end_times) FROM ts_cv_generate_folds(data, ds, 1, 2, MAP{});
----
1

# Request more folds than possible - should return fewer
query I
WITH data AS (
    SELECT CAST(d AS DATE) AS ds
    FROM (VALUES
        ('2023-01-01'), ('2023-02-01'), ('2023-03-01'), ('2023-04-01'),
        ('2023-05-01'), ('2023-06-01')
    ) AS t(d)
)
SELECT len(training_end_times) FROM ts_cv_generate_folds(data, ds, 5, 3, MAP{});
----
1
