# name: test/sql/ts_imputation.test
# description: Tests for NULL filling/imputation table functions (C++ API compatible)
# group: [sql]

require anofox_forecast

#######################################
# Setup Test Data
#######################################

statement ok
CREATE TABLE impute_test AS
SELECT 'A' AS id, '2023-01-01'::TIMESTAMP AS date, 1.0 AS val
UNION ALL SELECT 'A', '2023-01-02', NULL
UNION ALL SELECT 'A', '2023-01-03', 3.0
UNION ALL SELECT 'A', '2023-01-04', NULL
UNION ALL SELECT 'A', '2023-01-05', 5.0;

#######################################
# ts_fill_nulls_const - Fill with Constant
#######################################

# Test basic constant fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_const_by('impute_test', id, date, val, 0.0);
----
5

# Test no NULLs remain after fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_const_by('impute_test', id, date, val, 0.0) WHERE value_col IS NULL;
----
0

# Verify filled values
query R
SELECT SUM(value_col) FROM ts_fill_nulls_const_by('impute_test', id, date, val, 0.0);
----
9.0

#######################################
# ts_fill_nulls_forward - Forward Fill
#######################################

# Test basic forward fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_forward_by('impute_test', id, date, val);
----
5

# Test no NULLs remain after fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_forward_by('impute_test', id, date, val) WHERE value_col IS NULL;
----
0

# Verify forward fill carries previous value
query R
SELECT value_col FROM ts_fill_nulls_forward_by('impute_test', id, date, val) ORDER BY date LIMIT 1 OFFSET 1;
----
1.0

#######################################
# ts_fill_nulls_backward - Backward Fill
#######################################

# Test basic backward fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_backward_by('impute_test', id, date, val);
----
5

# Test no NULLs remain after fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_backward_by('impute_test', id, date, val) WHERE value_col IS NULL;
----
0

# Verify backward fill uses next value
query R
SELECT value_col FROM ts_fill_nulls_backward_by('impute_test', id, date, val) ORDER BY date LIMIT 1 OFFSET 1;
----
3.0

#######################################
# ts_fill_nulls_mean - Fill with Mean
#######################################

# Test basic mean fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_mean_by('impute_test', id, date, val);
----
5

# Test no NULLs remain after fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_mean_by('impute_test', id, date, val) WHERE value_col IS NULL;
----
0

# Verify mean fill uses series mean (mean of 1,3,5 = 3)
query R
SELECT value_col FROM ts_fill_nulls_mean_by('impute_test', id, date, val) ORDER BY date LIMIT 1 OFFSET 1;
----
3.0

#######################################
# Length Preservation Tests
#######################################

# All imputation functions should preserve row count
query IIII
SELECT
    (SELECT COUNT(*) FROM ts_fill_nulls_const_by('impute_test', id, date, val, 0.0)),
    (SELECT COUNT(*) FROM ts_fill_nulls_forward_by('impute_test', id, date, val)),
    (SELECT COUNT(*) FROM ts_fill_nulls_backward_by('impute_test', id, date, val)),
    (SELECT COUNT(*) FROM ts_fill_nulls_mean_by('impute_test', id, date, val));
----
5	5	5	5

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE impute_test;
