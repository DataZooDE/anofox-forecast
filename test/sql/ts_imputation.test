# name: test/sql/ts_imputation.test
# description: Tests for NULL filling/imputation table functions (C++ API compatible)
# group: [sql]

require anofox_forecast

#######################################
# Setup Test Data
#######################################

statement ok
CREATE TABLE impute_test AS
SELECT 'A' AS id, '2023-01-01'::TIMESTAMP AS date, 1.0 AS val
UNION ALL SELECT 'A', '2023-01-02', NULL
UNION ALL SELECT 'A', '2023-01-03', 3.0
UNION ALL SELECT 'A', '2023-01-04', NULL
UNION ALL SELECT 'A', '2023-01-05', 5.0;

#######################################
# ts_fill_nulls_const - Fill with Constant
#######################################

# Test basic constant fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_const_by('impute_test', id, date, val, 0.0);
----
5

# Test no NULLs remain after fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_const_by('impute_test', id, date, val, 0.0) WHERE filled_value IS NULL;
----
0

# Verify filled values
query R
SELECT SUM(filled_value) FROM ts_fill_nulls_const_by('impute_test', id, date, val, 0.0);
----
9.0

#######################################
# ts_fill_nulls_forward - Forward Fill
#######################################

# Test basic forward fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_forward_by('impute_test', id, date, val);
----
5

# Test no NULLs remain after fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_forward_by('impute_test', id, date, val) WHERE filled_value IS NULL;
----
0

# Verify forward fill carries previous value
query R
SELECT filled_value FROM ts_fill_nulls_forward_by('impute_test', id, date, val) ORDER BY date LIMIT 1 OFFSET 1;
----
1.0

#######################################
# ts_fill_nulls_backward - Backward Fill
#######################################

# Test basic backward fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_backward_by('impute_test', id, date, val);
----
5

# Test no NULLs remain after fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_backward_by('impute_test', id, date, val) WHERE filled_value IS NULL;
----
0

# Verify backward fill uses next value
query R
SELECT filled_value FROM ts_fill_nulls_backward_by('impute_test', id, date, val) ORDER BY date LIMIT 1 OFFSET 1;
----
3.0

#######################################
# ts_fill_nulls_mean - Fill with Mean
#######################################

# Test basic mean fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_mean_by('impute_test', id, date, val);
----
5

# Test no NULLs remain after fill
query I
SELECT COUNT(*) FROM ts_fill_nulls_mean_by('impute_test', id, date, val) WHERE filled_value IS NULL;
----
0

# Verify mean fill uses series mean (mean of 1,3,5 = 3)
query R
SELECT filled_value FROM ts_fill_nulls_mean_by('impute_test', id, date, val) ORDER BY date LIMIT 1 OFFSET 1;
----
3.0

#######################################
# Length Preservation Tests
#######################################

# All imputation functions should preserve row count
query IIII
SELECT
    (SELECT COUNT(*) FROM ts_fill_nulls_const_by('impute_test', id, date, val, 0.0)),
    (SELECT COUNT(*) FROM ts_fill_nulls_forward_by('impute_test', id, date, val)),
    (SELECT COUNT(*) FROM ts_fill_nulls_backward_by('impute_test', id, date, val)),
    (SELECT COUNT(*) FROM ts_fill_nulls_mean_by('impute_test', id, date, val));
----
5	5	5	5

#######################################
# Column Preservation Tests
#######################################

# Create table with extra columns
statement ok
CREATE TABLE impute_extra AS
SELECT 'A' AS id, '2023-01-01'::TIMESTAMP AS date, 1.0 AS val, 'x' AS extra_col, 100 AS num_col
UNION ALL SELECT 'A', '2023-01-02', NULL, 'y', 200;

# Test that extra columns are preserved by ts_fill_nulls_const_by
query I
SELECT COUNT(*) FROM ts_fill_nulls_const_by('impute_extra', id, date, val, 0.0) WHERE extra_col IS NOT NULL AND num_col IS NOT NULL;
----
2

# Test that extra columns are preserved by ts_fill_nulls_forward_by
query I
SELECT COUNT(*) FROM ts_fill_nulls_forward_by('impute_extra', id, date, val) WHERE extra_col IS NOT NULL AND num_col IS NOT NULL;
----
2

# Test that extra columns are preserved by ts_fill_nulls_backward_by
query I
SELECT COUNT(*) FROM ts_fill_nulls_backward_by('impute_extra', id, date, val) WHERE extra_col IS NOT NULL AND num_col IS NOT NULL;
----
2

# Test that extra columns are preserved by ts_fill_nulls_mean_by
query I
SELECT COUNT(*) FROM ts_fill_nulls_mean_by('impute_extra', id, date, val) WHERE extra_col IS NOT NULL AND num_col IS NOT NULL;
----
2

# Verify column values are preserved correctly
query TI
SELECT extra_col, num_col FROM ts_fill_nulls_const_by('impute_extra', id, date, val, 0.0) ORDER BY date;
----
x	100
y	200

statement ok
DROP TABLE impute_extra;

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE impute_test;
