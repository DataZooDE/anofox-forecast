# name: test/sql/core/test_arima_conditional.test
# description: Test ARIMA models (conditional on Eigen3 availability)
# group: [core]

require anofox_forecast

statement ok
LOAD anofox_forecast;

# Create test data
statement ok
CREATE TABLE test_series AS 
SELECT 
    i AS idx,
    100.0 + i * 2.0 + 10.0 * SIN(i * 2 * PI() / 12) AS value
FROM generate_series(1, 50) t(i);

# Test ARIMA (manual) - will either succeed or fail with "Unknown model" error
# This tests conditional compilation based on Eigen3 availability
statement maybe
SELECT COUNT(*) = 12
FROM ts_forecast(test_series, 'idx', 'value', 'ARIMA', 12, {'p': 1, 'd': 1, 'q': 1, 's': 12});

# Test AutoARIMA - will either succeed or fail with "Unknown model" error
statement maybe
SELECT COUNT(*) = 12
FROM ts_forecast(test_series, 'idx', 'value', 'AutoARIMA', 12, {'seasonal_period': 12});

# Verify that non-ARIMA models always work regardless of Eigen3
query I
SELECT COUNT(*) = 12
FROM ts_forecast(test_series, 'idx', 'value', 'AutoETS', 12, {'season_length': 12});
----
true

# Test: If ARIMA works, verify it returns valid results
statement maybe
CREATE TABLE arima_result AS
SELECT TS_FORECAST_AGG(idx, value, 'ARIMA', 5, {'p': 1, 'd': 1, 'q': 1}) AS result
FROM test_series;

statement maybe
SELECT len(result.point_forecast) = 5
FROM arima_result;

statement maybe
DROP TABLE arima_result;

# Test: If AutoARIMA works, verify it returns valid results
statement maybe
CREATE TABLE autoarima_result AS
SELECT TS_FORECAST_AGG(idx, value, 'AutoARIMA', 5, {'seasonal_period': 12}) AS result
FROM test_series;

statement maybe
SELECT len(result.point_forecast) = 5
FROM autoarima_result;

statement maybe
DROP TABLE autoarima_result;

# Cleanup
statement ok
DROP TABLE test_series;
