# name: test/sql/core/test_arima_conditional.test
# description: Test ARIMA models (requires Eigen3)
# group: [anofox_forecast]

# NOTE: This test will fail if Eigen3 is not available
# ARIMA and AutoARIMA models are only available when compiled with Eigen3

require anofox_forecast

statement ok
LOAD anofox_forecast;

# Create test data with TIMESTAMP
statement ok
CREATE TABLE test_series AS 
SELECT 
    ('2024-01-01'::TIMESTAMP + INTERVAL (i) DAY) AS date_col,
    100.0 + i * 2.0 + 10.0 * SIN(i * 2 * PI() / 12) AS value
FROM generate_series(1, 50) t(i);

# Test ARIMA (manual) - requires Eigen3
query I
SELECT COUNT(*) = 12
FROM ts_forecast(test_series, date_col, value, 'ARIMA', 12, {'p': 1, 'd': 1, 'q': 1, 's': 12});
----
true

# Test AutoARIMA - requires Eigen3
query I
SELECT COUNT(*) = 12
FROM ts_forecast(test_series, date_col, value, 'AutoARIMA', 12, {'seasonal_period': 12});
----
true

# Verify that non-ARIMA models always work regardless of Eigen3
query I
SELECT COUNT(*) = 12
FROM ts_forecast(test_series, date_col, value, 'AutoETS', 12, {'season_length': 12});
----
true

# Test ARIMA with aggregate function
statement ok
CREATE TABLE arima_result AS
SELECT TS_FORECAST_AGG(date_col, value, 'ARIMA', 5, {'p': 1, 'd': 1, 'q': 1}) AS result
FROM test_series;

query I
SELECT len(result.point_forecast) = 5
FROM arima_result;
----
true

# Test AutoARIMA with aggregate function
statement ok
CREATE TABLE autoarima_result AS
SELECT TS_FORECAST_AGG(date_col, value, 'AutoARIMA', 5, {'seasonal_period': 12}) AS result
FROM test_series;

query I
SELECT len(result.point_forecast) = 5
FROM autoarima_result;
----
true

# Cleanup
statement ok
DROP TABLE test_series;

statement ok
DROP TABLE arima_result;

statement ok
DROP TABLE autoarima_result;
