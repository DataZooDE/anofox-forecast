# name: test/sql/core/test_arima_conditional.test
# description: Test ARIMA models (conditional on Eigen3 availability)
# group: [core]

require anofox_forecast

statement ok
LOAD anofox_forecast;

# Create test data
statement ok
CREATE TABLE test_series AS 
SELECT 
    i AS idx,
    100.0 + i * 2.0 + 10.0 * SIN(i * 2 * PI() / 12) AS value
FROM generate_series(1, 50) t(i);

# Check if ARIMA is available (depends on Eigen3)
statement ok
CREATE TABLE arima_available AS
SELECT COUNT(*) > 0 AS has_arima
FROM ts_list_models()
WHERE model_name = 'ARIMA';

# Test ARIMA (manual) - only if Eigen3 available
# This will either succeed or fail with "Unknown model" error
# We test that it doesn't crash
statement maybe
SELECT len(result.forecast) = 12
FROM (SELECT TS_FORECAST(value, 'ARIMA', 12, {'p': 1, 'd': 1, 'q': 1, 's': 12}) AS result FROM test_series);

# Test Auto ARIMA - only if Eigen3 available
statement maybe
SELECT len(result.forecast) = 12
FROM (SELECT TS_FORECAST(value, 'AutoARIMA', 12, {'seasonal_period': 12}) AS result FROM test_series);

# Verify that if ARIMA is not available, we get a clear error message
# (This is tested implicitly by the maybe statements above)

# Verify that non-ARIMA models always work regardless of Eigen3
query I
SELECT len(result.forecast) = 12
FROM (SELECT TS_FORECAST(value, 'AutoETS', 12, {'season_length': 12}) AS result FROM test_series);
----
true

# Cleanup
statement ok
DROP TABLE test_series;

statement ok
DROP TABLE arima_available;

