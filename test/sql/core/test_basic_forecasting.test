# name: test/sql/core/test_basic_forecasting.test
# description: Basic forecasting functionality test
# group: [core]

require anofox_forecast

statement ok
LOAD anofox_forecast;

# Create test data with TIMESTAMP
statement ok
CREATE TABLE test_data AS
SELECT 
    ('2024-01-01'::TIMESTAMP + INTERVAL (i) DAY) AS date_col,
    (100.0 + i)::DOUBLE AS value
FROM generate_series(1, 30) t(i);

# Test 1: Basic forecast with Naive model
query I
SELECT COUNT(*) = 10
FROM ts_forecast(test_data, date_col, value, 'Naive', 10, NULL);
----
true

# Test 2: Forecast with SES model
query I
SELECT COUNT(*) = 10
FROM ts_forecast(test_data, date_col, value, 'SES', 10, {'alpha': 0.3});
----
true

# Test 3: Forecast with AutoETS model
query I
SELECT COUNT(*) = 10
FROM ts_forecast(test_data, date_col, value, 'AutoETS', 10, {'season_length': 7});
----
true

# Test 4: Using TS_FORECAST_AGG directly
statement ok
CREATE TABLE agg_result AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, NULL) AS result
FROM test_data;

query I
SELECT len(result.point_forecast) = 5
FROM agg_result;
----
true

# Test 5: In-sample forecasts
statement ok
CREATE TABLE insample_result AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'return_insample': true}) AS result
FROM test_data;

query I
SELECT len(result.insample_fitted) = 30
FROM insample_result;
----
true

# Test 6: Custom confidence level
statement ok
CREATE TABLE conf_result AS
SELECT TS_FORECAST_AGG(date_col, value, 'Naive', 5, {'confidence_level': 0.95}) AS result
FROM test_data;

query R
SELECT result.confidence_level
FROM conf_result;
----
0.950000

# Test 7: Multiple series with ts_forecast_by
statement ok
CREATE TABLE multi_series AS
SELECT 
    ('2024-01-01'::TIMESTAMP + INTERVAL (i) DAY) AS date_col,
    (i % 3)::VARCHAR AS series_id,
    (100.0 + i * (i % 3 + 1))::DOUBLE AS value
FROM generate_series(1, 30) t(i);

query I
SELECT COUNT(DISTINCT series_id) = 3
FROM ts_forecast_by(multi_series, series_id, date_col, value, 'Naive', 5, NULL);
----
true

# Cleanup
statement ok
DROP TABLE test_data;

statement ok
DROP TABLE agg_result;

statement ok
DROP TABLE insample_result;

statement ok
DROP TABLE conf_result;

statement ok
DROP TABLE multi_series;

