# name: test/sql/core/test_ts_features.test
# description: Validate ts_features aggregate with grouping and window usage
# group: [core]

require anofox_forecast

statement ok
LOAD anofox_forecast;

statement ok
CREATE TABLE ts_feature_data AS
SELECT 
    (i % 2) AS grp,
    (TIMESTAMP '2024-01-01' + i * INTERVAL '1 day') AS ts,
    i::DOUBLE AS val
FROM generate_series(0, 5) t(i);

# abs_energy over entire dataset = sum(i^2) from 0..5 = 55
query I
SELECT ROUND((ts_features(ts, val)).abs_energy, 6) 
FROM ts_feature_data;
----
55.0

# length per group should be 3 rows each
query I
SELECT grp, (ts_features(ts, val)).length AS len
FROM ts_feature_data
GROUP BY grp
ORDER BY grp;
----
0	3
1	3

# Rolling window length with 2 preceding rows
query I
SELECT grp, ts::DATE, (ts_features(ts, val) OVER (
    PARTITION BY grp ORDER BY ts
    ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
)).length AS win_len
FROM ts_feature_data
ORDER BY grp, ts;
----
0	2024-01-01	1
0	2024-01-03	2
0	2024-01-05	3
1	2024-01-02	1
1	2024-01-04	2
1	2024-01-06	3

# Verify a parameterized feature column exists
query I
SELECT (ts_features(ts, val)).autocorrelation__lag_1 IS NOT NULL
FROM ts_feature_data;
----
true

