# name: test/sql/ts_decomposition.test
# description: Tests for ts_mstl_decomposition MSTL decomposition function
# group: [sql]

require anofox_forecast

#######################################
# Basic Decomposition Tests
#######################################

# Test decomposition returns STRUCT with trend
query I
SELECT (ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).trend IS NOT NULL;
----
true

# Test decomposition returns STRUCT with seasonal
query I
SELECT (ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).seasonal IS NOT NULL;
----
true

# Test decomposition returns STRUCT with remainder
query I
SELECT (ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).remainder IS NOT NULL;
----
true

# Test decomposition returns STRUCT with periods
query I
SELECT (ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).periods IS NOT NULL;
----
true

#######################################
# Component Length Tests
#######################################

# Trend should have same length as input
query I
SELECT length((ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).trend);
----
12

# Remainder should have same length as input
query I
SELECT length((ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).remainder);
----
12

#######################################
# Seasonal Pattern Tests
#######################################

# Test with clear seasonal pattern (period 4)
query I
SELECT length((ts_mstl_decomposition([10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0])).trend);
----
16

# Seasonal component should be a list of lists (one per period)
query I
SELECT length((ts_mstl_decomposition([10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0])).seasonal) >= 0;
----
true

#######################################
# Trend Component Tests
#######################################

# Linear trend - trend component should capture the linear pattern
query I
SELECT (ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).trend[1] IS NOT NULL;
----
true

# Trend should increase for increasing data
query I
SELECT (ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).trend[12] >
       (ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).trend[1];
----
true

#######################################
# Remainder Component Tests
#######################################

# For perfect linear trend, remainder should be small
query I
SELECT ABS((ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).remainder[6]) < 5.0;
----
true

#######################################
# Constant Series Tests
#######################################

# Constant series - trend should be constant
query I
SELECT ABS((ts_mstl_decomposition([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0])).trend[1] - 5.0) < 1.0;
----
true

#######################################
# NULL Handling
#######################################

# NULL input should return NULL
query I
SELECT ts_mstl_decomposition(NULL) IS NULL;
----
true

#######################################
# Alias Test
#######################################

# Test anofox_fcst_ts_mstl_decomposition alias
query I
SELECT (anofox_fcst_ts_mstl_decomposition([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).trend IS NOT NULL;
----
true

