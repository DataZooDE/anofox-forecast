# name: test/sql/ts_forecast_ets_model.test
# description: Tests for ETS model parameter in ts_forecast_by
# group: [sql]

require anofox_forecast

#######################################
# Setup: Create test data
#######################################

# Time series data with trend and seasonality for ETS models
statement ok
CREATE TABLE test_ets AS
SELECT
    'A' AS id,
    ('2024-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS ds,
    100.0 + i * 0.5 + sin(i * 2 * 3.14159 / 7) * 10 AS value
FROM generate_series(0, 83) AS t(i)
UNION ALL
SELECT
    'B' AS id,
    ('2024-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS ds,
    200.0 + i * 0.3 + cos(i * 2 * 3.14159 / 7) * 15 AS value
FROM generate_series(0, 83) AS t(i);

#######################################
# Default Behavior Tests
#######################################

# Test: ETS without model parameter uses default (AAA)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{});
----
14

# Test: ETS returns valid forecasts by default
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{})
WHERE point_forecast IS NOT NULL AND point_forecast > 0;
----
14

#######################################
# Explicit Model Specification Tests
#######################################

# Test: ETS with explicit model='AAA' (Additive error, Additive trend, Additive seasonal)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'AAA'});
----
14

# Test: ETS with model='ANA' (Additive error, No trend, Additive seasonal)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'ANA'});
----
14

# Test: ETS with model='ANN' (Additive error, No trend, No seasonal - simple exponential smoothing)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'ANN'});
----
14

# Test: ETS with model='AAN' (Additive error, Additive trend, No seasonal - Holt's method)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'AAN'});
----
14

# Test: ETS with model='MNM' (Multiplicative error, No trend, Multiplicative seasonal)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'MNM'});
----
14

# Test: ETS with model='MAM' (Multiplicative error, Additive trend, Multiplicative seasonal)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'MAM'});
----
14

# Test: ETS with model='MNN' (Multiplicative error, No trend, No seasonal)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'MNN'});
----
14

#######################################
# Damped Trend Tests
#######################################

# Test: ETS with model='AAdA' (Additive error, Additive damped trend, Additive seasonal)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'AAdA'});
----
14

# Test: ETS with model='AAdN' (Additive error, Additive damped trend, No seasonal)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'AAdN'});
----
14

# Test: ETS with model='MAdM' (Multiplicative error, Additive damped trend, Multiplicative seasonal)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'MAdM'});
----
14

#######################################
# Case Sensitivity Tests
#######################################

# Test: model parameter is case-sensitive - uppercase required
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'AAA'});
----
14

#######################################
# Invalid Specification Tests
#######################################

# Test: Invalid model spec returns error
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'XYZ'});
----
Invalid ETS model specification

# Test: Invalid model spec with wrong characters
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': '123'});
----
Invalid ETS model specification

#######################################
# Unstable Model Rejection Tests (FPP3 Taxonomy)
#######################################

# Test: MAA (Multiplicative error, Additive trend, Additive seasonal) is unstable - rejected
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'MAA'});
----
unstable

# Test: MAdA (Multiplicative error, Additive damped trend, Additive seasonal) is unstable - rejected
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'MAdA'});
----
unstable

#######################################
# Combined Parameters Tests
#######################################

# Test: model parameter with seasonal_period
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7,
    MAP{'model': 'AAA', 'seasonal_period': '7'});
----
14

# Test: model parameter with confidence_level
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7,
    MAP{'model': 'ANA', 'confidence_level': '0.95'});
----
14

#######################################
# Forecast Quality Tests
#######################################

# Test: Forecasts have valid confidence intervals
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'AAA'})
WHERE lower_90 <= point_forecast AND point_forecast <= upper_90;
----
14

# Test: Different models produce different forecasts (not all identical)
query I
SELECT COUNT(DISTINCT round(point_forecast, 2)) > 1 AS has_variation
FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, MAP{'model': 'AAA'});
----
true

#######################################
# Aggregate Function Tests
#######################################

# Test: ts_forecast_agg with model parameter
query I
SELECT COUNT(*) FROM (
    SELECT id, ts_forecast_agg(ds, value, 'ETS', 7, MAP{'model': 'AAA'}) AS forecast
    FROM test_ets
    GROUP BY id
);
----
2

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE test_ets;
