# name: test/sql/ts_forecast_ets_model.test
# description: Tests for ETS model parameter in ts_forecast_by
# group: [sql]

require anofox_forecast

require json

#######################################
# Setup: Create test data
#######################################

# Time series data with trend and seasonality for ETS models
statement ok
CREATE TABLE test_ets AS
SELECT
    'A' AS id,
    ('2024-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS ds,
    100.0 + i * 0.5 + sin(i * 2 * 3.14159 / 7) * 10 AS value
FROM generate_series(0, 83) AS t(i)
UNION ALL
SELECT
    'B' AS id,
    ('2024-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS ds,
    200.0 + i * 0.3 + cos(i * 2 * 3.14159 / 7) * 15 AS value
FROM generate_series(0, 83) AS t(i);

#######################################
# Default Behavior Tests
#######################################

# Test: ETS without model parameter uses simplified fallback
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d', MAP{});
----
14

# Test: ETS returns valid forecasts by default
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d', MAP{})
WHERE yhat IS NOT NULL AND yhat > 0;
----
14

#######################################
# Explicit Model Specification Tests
# Note: Explicit ETS specs are now passed through properly (fix for #177).
# The ETS library has a known issue where explicit specs fail to fit.
# Instead of silently falling back, we now return an actionable error.
#######################################

# Test: ETS with explicit model='AAA' — valid spec, but if fit fails groups are
# skipped (0 rows returned). Pipeline continues, no error thrown.
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d', MAP{'model': 'AAA'});
----
0

# Test: ETS with model='ANN' — same: valid spec, groups skipped if fit fails
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d', MAP{'model': 'ANN'});
----
0

#######################################
# Invalid Specification Tests
#######################################

# Test: Invalid model spec returns error
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d', MAP{'model': 'XYZ'});
----
Invalid ETS model specification

# Test: Invalid model spec with wrong characters
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d', MAP{'model': '123'});
----
Invalid ETS model specification

#######################################
# Unstable Model Rejection Tests (FPP3 Taxonomy)
#######################################

# Test: MAA (Multiplicative error, Additive trend, Additive seasonal) is unstable - rejected
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d', MAP{'model': 'MAA'});
----
unstable

# Test: MAdA (Multiplicative error, Additive damped trend, Additive seasonal) is unstable - rejected
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d', MAP{'model': 'MAdA'});
----
unstable

#######################################
# Parameter Validation Tests (#177)
#######################################

# Test: 'model' param is only valid with ETS method
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'Naive', 7, '1d', MAP{'model': 'AAA'});
----
only valid when method='ETS'

# Test: Unknown parameter key gives error
statement error
SELECT * FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d', MAP{'methd': 'AAA'});
----
Unknown parameter

# Test: model parameter with confidence_level (no model spec)
query I
SELECT COUNT(*) FROM ts_forecast_by('test_ets', id, ds, value, 'ETS', 7, '1d',
    MAP{'confidence_level': '0.95'});
----
14

#######################################
# Aggregate Function Tests
#######################################

# Test: ts_forecast_agg with ETS (default, no explicit spec)
query I
SELECT COUNT(*) FROM (
    SELECT id, ts_forecast_agg(ds, value, 'ETS', 7, MAP{}) AS forecast
    FROM test_ets
    GROUP BY id
);
----
2

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE test_ets;
