# name: test/sql/changepoint/test_changepoints_simple.test
# description: Test simple changepoint detection with aggregate function
# group: [changepoint]

require anofox_forecast

statement ok
LOAD anofox_forecast;

# Create test data with a clear changepoint at day 50
statement ok
DROP TABLE IF EXISTS cp_test;

statement ok
CREATE TABLE cp_test AS
SELECT 
    DATE '2023-01-01' + INTERVAL (d) DAY AS ds,
    CASE 
        WHEN d < 50 THEN 100 + (RANDOM() * 5)
        ELSE 200 + (RANDOM() * 5)
    END AS y
FROM generate_series(0, 99) t(d);

# Verify table has correct number of rows
query I
SELECT COUNT(*) = 100
FROM cp_test;
----
true

# Test that aggregate function detects changepoints
query I
SELECT COUNT(*) > 0
FROM (
    WITH changepoints AS (
        SELECT anofox_fcst_ts_detect_changepoints_agg(ds, y) AS result
        FROM cp_test
    ),
    unnested AS (
        SELECT UNNEST(result) AS row_data
        FROM changepoints
    )
    SELECT 
        row_data.timestamp AS ds,
        row_data.value AS y,
        row_data.is_changepoint
    FROM unnested
    WHERE row_data.is_changepoint = true
);
----
true

# Verify all data points are returned with changepoint indicators
query I
SELECT COUNT(*) = 100
FROM (
    WITH changepoints AS (
        SELECT anofox_fcst_ts_detect_changepoints_agg(ds, y) AS result
        FROM cp_test
    ),
    unnested AS (
        SELECT UNNEST(result) AS row_data
        FROM changepoints
    )
    SELECT 
        row_data.timestamp AS ds,
        row_data.value AS y,
        row_data.is_changepoint
    FROM unnested
);
----
true

# Verify the result structure has expected fields
query I
SELECT 
    COUNT(*) = 3
FROM (
    WITH changepoints AS (
        SELECT anofox_fcst_ts_detect_changepoints_agg(ds, y) AS result
        FROM cp_test
    ),
    unnested AS (
        SELECT UNNEST(result) AS row_data
        FROM changepoints
    )
    SELECT * FROM (
        DESCRIBE 
        SELECT 
            row_data.timestamp AS ds,
            row_data.value AS y,
            row_data.is_changepoint
        FROM unnested
        LIMIT 1
    )
);
----
true

# Test that changepoints are boolean values
query I
SELECT 
    COUNT(DISTINCT row_data.is_changepoint) <= 2
FROM (
    WITH changepoints AS (
        SELECT anofox_fcst_ts_detect_changepoints_agg(ds, y) AS result
        FROM cp_test
    )
    SELECT UNNEST(result) AS row_data
    FROM changepoints
);
----
true

