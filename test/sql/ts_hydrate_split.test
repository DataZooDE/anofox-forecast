# name: test/sql/ts_hydrate_split.test
# description: Tests for ts_cv_hydrate_by - join CV folds with source data and mask unknown features
# group: [sql]

require anofox_forecast

#######################################
# Setup Test Data
#######################################

statement ok
CREATE TABLE backtest_sample AS
SELECT
    category,
    '2022-01-01'::DATE + ((i - 1) * INTERVAL '1 month') AS date,
    (100 + i * 5 + CASE WHEN category = 'A' THEN 50 ELSE 0 END)::DOUBLE AS sales,
    (i % 2)::INT AS promotion,
    (50 + (i % 12) * 3)::DOUBLE AS temperature
FROM generate_series(1, 24) AS t(i)
CROSS JOIN (SELECT 'A' AS category UNION ALL SELECT 'B') AS c;

# ts_cv_folds_by creates folds with: category, date, sales, fold_id, split
statement ok
CREATE TABLE cv_folds AS
SELECT *
FROM ts_cv_folds_by(
    'backtest_sample', category, date, sales,
    3, 3, MAP{}
);

# Verify cv_folds has original column names
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM cv_folds
) WHERE column_name IN ('category', 'date', 'sales');
----
3

#######################################
# ts_cv_hydrate_by - Basic Join Test
#######################################

# Should return all source columns plus fold metadata
query I
SELECT COUNT(*) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'], MAP{}
) WHERE fold_id = 1;
----
36

# Should have _is_test boolean column
query II
SELECT _is_test, COUNT(*) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'], MAP{}
) WHERE fold_id = 1
GROUP BY _is_test
ORDER BY _is_test;
----
false	30
true	6

# Should have _train_cutoff timestamp
query I
SELECT COUNT(DISTINCT _train_cutoff) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'], MAP{}
) WHERE fold_id = 1;
----
1

#######################################
# ts_cv_hydrate_by - NULL Strategy
#######################################

# Using _is_test to mask temperature in test rows
query II
SELECT split, COUNT(*) FROM (
    SELECT
        split,
        CASE WHEN _is_test THEN NULL ELSE temperature END AS masked_temp
    FROM ts_cv_hydrate_by(
        'cv_folds', 'backtest_sample', category, date, ['temperature'],
        MAP{'strategy': 'null'}
    )
    WHERE fold_id = 1 AND category = 'A'
) WHERE masked_temp IS NULL OR masked_temp IS NOT NULL
GROUP BY split
ORDER BY split DESC;
----
train	15
test	3

# Verify train rows have actual temperature values
query I
SELECT COUNT(*) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'null'}
) WHERE fold_id = 1 AND split = 'train' AND temperature IS NOT NULL;
----
30

#######################################
# ts_cv_hydrate_by - LAST_VALUE Strategy
#######################################

# _last_known map should have the last training value for temperature
query I
SELECT COUNT(DISTINCT _last_known['temperature']) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'last_value'}
) WHERE fold_id = 1 AND category = 'A' AND split = 'test';
----
1

# Using _last_known to carry forward last training value
query II
SELECT split, COUNT(*) FROM (
    SELECT
        split,
        CASE WHEN _is_test THEN _last_known['temperature'] ELSE temperature::VARCHAR END AS filled_temp
    FROM ts_cv_hydrate_by(
        'cv_folds', 'backtest_sample', category, date, ['temperature'],
        MAP{'strategy': 'last_value'}
    )
    WHERE fold_id = 1 AND category = 'A'
) WHERE filled_temp IS NOT NULL
GROUP BY split
ORDER BY split DESC;
----
train	15
test	3

#######################################
# ts_cv_hydrate_by - DEFAULT Strategy
#######################################

# _last_known should contain fill_value for default strategy
query I
SELECT DISTINCT _last_known['temperature'] FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'default', 'fill_value': '999'}
) WHERE fold_id = 1 AND category = 'A' AND split = 'test';
----
999.0

#######################################
# ts_cv_hydrate_by - Multiple Unknown Features
#######################################

# Test with multiple unknown features
query I
SELECT COUNT(*) FROM (
    SELECT * FROM ts_cv_hydrate_by(
        'cv_folds', 'backtest_sample', category, date,
        ['temperature', 'promotion'],
        MAP{'strategy': 'last_value'}
    )
    WHERE fold_id = 1
);
----
36

# _last_known should have entries for both columns
query I
SELECT COUNT(*) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date,
    ['temperature', 'promotion'],
    MAP{'strategy': 'last_value'}
) WHERE fold_id = 1 AND category = 'A' AND split = 'test'
  AND _last_known['temperature'] IS NOT NULL
  AND _last_known['promotion'] IS NOT NULL;
----
3

#######################################
# Multiple Folds Test
#######################################

# Each fold should have train and test splits
query III
SELECT fold_id, split, COUNT(*) as n FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'], MAP{}
)
GROUP BY fold_id, split
ORDER BY fold_id, split DESC;
----
1	train	30
1	test	6
2	train	36
2	test	6
3	train	42
3	test	6

#######################################
# Manual Masking Pattern (Recommended)
#######################################

# The recommended pattern: use _is_test for explicit masking
query III
SELECT
    fold_id,
    split,
    SUM(CASE WHEN _is_test THEN NULL ELSE temperature END) IS NOT NULL as has_train_temps
FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'], MAP{}
)
WHERE fold_id = 1 AND category = 'A'
GROUP BY fold_id, split
ORDER BY split DESC;
----
1	train	true
1	test	false

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE backtest_sample;

statement ok
DROP TABLE cv_folds;
