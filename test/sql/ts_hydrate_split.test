# name: test/sql/ts_hydrate_split.test
# description: Tests for ts_cv_hydrate_by - hydrate CV folds with unknown features (masking applied automatically)
# group: [sql]

require anofox_forecast

require json

#######################################
# Setup Test Data
#######################################

statement ok
CREATE TABLE backtest_sample AS
SELECT
    category,
    '2022-01-01'::DATE + ((i - 1) * INTERVAL '1 month') AS date,
    (100 + i * 5 + CASE WHEN category = 'A' THEN 50 ELSE 0 END)::DOUBLE AS sales,
    (i % 2)::INT AS promotion,
    (50 + (i % 12) * 3)::DOUBLE AS temperature
FROM generate_series(1, 24) AS t(i)
CROSS JOIN (SELECT 'A' AS category UNION ALL SELECT 'B') AS c;

# ts_cv_folds_by creates folds with: category, date, sales, fold_id, split
statement ok
CREATE TABLE cv_folds AS
SELECT *
FROM ts_cv_folds_by(
    'backtest_sample', category, date, sales,
    3, 3, MAP{}
);

# Verify cv_folds has original column names
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM cv_folds
) WHERE column_name IN ('category', 'date', 'sales');
----
3

#######################################
# ts_cv_hydrate_by - Basic Join Test
#######################################

# Should return all cv_folds columns plus unknown MAP
query I
SELECT COUNT(*) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'], MAP{}
) WHERE fold_id = 1;
----
36

# Should have split column for train/test identification
query II
SELECT split, COUNT(*) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'], MAP{}
) WHERE fold_id = 1
GROUP BY split
ORDER BY split;
----
test	6
train	30

#######################################
# ts_cv_hydrate_by - Automatic Masking
#######################################

# Train rows should have actual values (multiple distinct temps)
# Test rows should have filled values (single value per strategy)
query II
SELECT split, COUNT(DISTINCT unknown['temperature']) AS distinct_temps
FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'last_value'}
)
WHERE fold_id = 1 AND category = 'A'
GROUP BY split
ORDER BY split;
----
test	1
train	12

#######################################
# ts_cv_hydrate_by - NULL Strategy
#######################################

# Test rows should have NULL, train rows should have actual values
query II
SELECT split, COUNT(*) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'null'}
)
WHERE fold_id = 1 AND category = 'A' AND unknown['temperature'] IS NULL
GROUP BY split;
----
test	3

# Train rows should NOT have NULL
query I
SELECT COUNT(*) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'null'}
)
WHERE fold_id = 1 AND split = 'train' AND unknown['temperature'] IS NOT NULL;
----
30

#######################################
# ts_cv_hydrate_by - LAST_VALUE Strategy
#######################################

# Test rows should all have the same last known value
query I
SELECT COUNT(DISTINCT unknown['temperature']) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'last_value'}
) WHERE fold_id = 1 AND category = 'A' AND split = 'test';
----
1

# Train rows should have varied actual values
query I
SELECT COUNT(DISTINCT unknown['temperature']) > 1 AS has_variety FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'last_value'}
) WHERE fold_id = 1 AND category = 'A' AND split = 'train';
----
true

#######################################
# ts_cv_hydrate_by - DEFAULT Strategy
#######################################

# Test rows should have fill_value
query I
SELECT DISTINCT unknown['temperature'] FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'default', 'fill_value': '999'}
) WHERE fold_id = 1 AND category = 'A' AND split = 'test';
----
999.0

#######################################
# ts_cv_hydrate_by - Multiple Unknown Features
#######################################

# Test with multiple unknown features
query I
SELECT COUNT(*) FROM (
    SELECT * FROM ts_cv_hydrate_by(
        'cv_folds', 'backtest_sample', category, date,
        ['temperature', 'promotion'],
        MAP{'strategy': 'last_value'}
    )
    WHERE fold_id = 1
);
----
36

# Both columns should be present in unknown MAP
query I
SELECT COUNT(*) FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date,
    ['temperature', 'promotion'],
    MAP{'strategy': 'last_value'}
) WHERE fold_id = 1 AND category = 'A' AND split = 'test'
  AND unknown['temperature'] IS NOT NULL
  AND unknown['promotion'] IS NOT NULL;
----
3

#######################################
# Multiple Folds Test
#######################################

# Each fold should have train and test splits
query III
SELECT fold_id, split, COUNT(*) as n FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'], MAP{}
)
GROUP BY fold_id, split
ORDER BY fold_id, split DESC;
----
1	train	30
1	test	6
2	train	36
2	test	6
3	train	42
3	test	6

#######################################
# Direct Usage Pattern (No CASE WHEN needed)
#######################################

# Output is immediately usable - just extract from unknown MAP
query III
SELECT
    fold_id,
    split,
    unknown['temperature'] IS NOT NULL AS has_temp
FROM ts_cv_hydrate_by(
    'cv_folds', 'backtest_sample', category, date, ['temperature'],
    MAP{'strategy': 'last_value'}
)
WHERE fold_id = 1 AND category = 'A'
GROUP BY fold_id, split, unknown['temperature'] IS NOT NULL
ORDER BY split DESC;
----
1	train	true
1	test	true

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE backtest_sample;

statement ok
DROP TABLE cv_folds;
