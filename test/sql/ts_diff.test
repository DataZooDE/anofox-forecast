# name: test/sql/ts_diff.test
# description: Tests for ts_diff table function (C++ API compatible)
# group: [sql]

require anofox_forecast

#######################################
# Setup Test Data
#######################################

statement ok
CREATE TABLE diff_series AS
SELECT 'A' AS id, ('2023-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS date, (i + 1)::DOUBLE AS val
FROM generate_series(0, 4) AS t(i);

#######################################
# Table Function API Tests
#######################################

# First order differencing
query I
SELECT COUNT(*) FROM ts_diff('diff_series', id, date, val, 1);
----
5

# First difference - check values
query I
SELECT COUNT(*) FROM ts_diff('diff_series', id, date, val, 1) WHERE diff_value IS NOT NULL;
----
4

# First difference should be 1.0 for linear increasing
query I
SELECT ABS(diff_value - 1.0) < 0.01 FROM ts_diff('diff_series', id, date, val, 1) WHERE diff_value IS NOT NULL ORDER BY date LIMIT 1;
----
true

#######################################
# Second Order Differencing
#######################################

# Second difference
query I
SELECT COUNT(*) FROM ts_diff('diff_series', id, date, val, 2);
----
5

# Second difference - should have 3 non-null values
query I
SELECT COUNT(*) FROM ts_diff('diff_series', id, date, val, 2) WHERE diff_value IS NOT NULL;
----
3

# Second lag difference of linear series with slope 1 should be 2 (val[i] - val[i-2])
query I
SELECT ABS(diff_value - 2.0) < 0.01 FROM ts_diff('diff_series', id, date, val, 2) WHERE diff_value IS NOT NULL ORDER BY date LIMIT 1;
----
true

#######################################
# Quadratic Series
#######################################

statement ok
CREATE TABLE quadratic_series AS
SELECT 'X' AS id, ('2023-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS date, ((i+1)*(i+1))::DOUBLE AS val
FROM generate_series(0, 4) AS t(i);

# LAG-based second difference of quadratic series [(i+1)^2] gives increasing values
# Values: [1, 4, 9, 16, 25] with LAG(2) diff: [NULL, NULL, 8, 12, 16]
query I
SELECT COUNT(*) FROM ts_diff('quadratic_series', id, date, val, 2) WHERE diff_value IS NOT NULL;
----
3

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE diff_series;

statement ok
DROP TABLE quadratic_series;
