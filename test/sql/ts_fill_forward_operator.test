# name: test/sql/ts_fill_forward_operator.test
# description: Tests for ts_fill_forward table macro (fill forward to target date)
# group: [anofox_forecast]

require anofox_forecast

#######################################
# Setup - Create test data
#######################################

# Create a simple grouped time series
statement ok
CREATE TABLE test_series AS
SELECT 'A' AS id,
       ('2024-01-01'::DATE + (i || ' days')::INTERVAL)::TIMESTAMP AS ds,
       (10.0 + i)::DOUBLE AS value
FROM generate_series(0, 4) AS t(i)
UNION ALL
SELECT 'B' AS id,
       ('2024-01-01'::DATE + (i || ' days')::INTERVAL)::TIMESTAMP AS ds,
       (100.0 + i * 5)::DOUBLE AS value
FROM generate_series(0, 4) AS t(i);

#######################################
# ts_fill_forward - Basic Function Tests
#######################################

# Test function returns results
query I
SELECT COUNT(*) > 0 FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d');
----
true

# Test original data is preserved
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d')
WHERE value_col IS NOT NULL;
----
10

# Test forward fill adds rows with NULL values
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d')
WHERE value_col IS NULL;
----
10

# Total rows should be original + filled
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d');
----
20

#######################################
# Group Handling Tests
#######################################

# Both groups should have filled rows
query I
SELECT COUNT(DISTINCT group_col) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d');
----
2

# Group A should have correct count (5 original + 5 filled)
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d')
WHERE group_col = 'A';
----
10

# Group B should have correct count (5 original + 5 filled)
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d')
WHERE group_col = 'B';
----
10

#######################################
# Date Range Tests
#######################################

# Filled dates should be after original last date (2024-01-05)
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d')
WHERE date_col > '2024-01-05'::TIMESTAMP AND value_col IS NULL;
----
10

# All filled dates should be <= target date
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d')
WHERE date_col > '2024-01-10'::TIMESTAMP;
----
0

#######################################
# Value Handling Tests
#######################################

# Original values should be preserved exactly
# A: 10+11+12+13+14 = 60, B: 100+105+110+115+120 = 550, Total = 610
query R
SELECT SUM(value_col) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d')
WHERE value_col IS NOT NULL;
----
610.0

# Filled values should be NULL
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-10', '1d')
WHERE date_col > '2024-01-05'::TIMESTAMP AND value_col IS NOT NULL;
----
0

#######################################
# Target Date At/Before Last Date
#######################################

# If target date equals last date, should return original data only
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-05', '1d');
----
10

#######################################
# Frequency Parameter Tests
#######################################

# Polars-style '1d' frequency
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-08', '1d');
----
16

# DuckDB INTERVAL style '1 day'
query I
SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-08', '1 day');
----
16

# Hourly frequency (more granular)
query I
SELECT (SELECT COUNT(*) FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-05 12:00:00', '1h')) > 10;
----
true

#######################################
# Ordering Tests
#######################################

# Results should be ordered by group, then date
query TT
SELECT group_col, date_col FROM ts_fill_forward_by('test_series', id, ds, value, '2024-01-07', '1d')
ORDER BY group_col, date_col
LIMIT 3;
----
A	2024-01-01 00:00:00
A	2024-01-02 00:00:00
A	2024-01-03 00:00:00

#######################################
# Single Group Test
#######################################

statement ok
CREATE TABLE single_group AS
SELECT 'X' AS id,
       ('2024-01-01'::DATE + (i || ' days')::INTERVAL)::TIMESTAMP AS ds,
       (i * 10.0)::DOUBLE AS value
FROM generate_series(0, 2) AS t(i);

# Single group should work correctly
query I
SELECT COUNT(*) FROM ts_fill_forward_by('single_group', id, ds, value, '2024-01-05', '1d');
----
5

# Verify values for single group
query IR
SELECT date_col, value_col FROM ts_fill_forward_by('single_group', id, ds, value, '2024-01-05', '1d')
ORDER BY date_col;
----
2024-01-01 00:00:00	0.0
2024-01-02 00:00:00	10.0
2024-01-03 00:00:00	20.0
2024-01-04 00:00:00	NULL
2024-01-05 00:00:00	NULL

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE test_series;

statement ok
DROP TABLE single_group;
