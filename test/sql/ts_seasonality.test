# name: test/sql/ts_seasonality.test
# description: Tests for ts_detect_seasonality and ts_analyze_seasonality functions
# group: [sql]

require anofox_forecast

require json

#######################################
# ts_detect_seasonality - Basic Tests
#######################################

# Seasonal pattern with period 4 - should detect period
query I
SELECT length(ts_detect_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])) >= 0;
----
true

# Non-seasonal (linear trend) - may return empty or no strong periods
query I
SELECT ts_detect_seasonality([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]) IS NOT NULL;
----
true

# Constant series - should return a result (possibly empty list)
query I
SELECT ts_detect_seasonality([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0]) IS NOT NULL;
----
true

#######################################
# ts_analyze_seasonality - STRUCT Result Tests
#######################################

# Test detected_periods field exists
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).detected_periods IS NOT NULL;
----
true

# Test primary_period field exists
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).primary_period IS NOT NULL;
----
true

# Test seasonal_strength field exists
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).seasonal_strength IS NOT NULL;
----
true

# Test trend_strength field exists
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).trend_strength IS NOT NULL;
----
true

#######################################
# Strong Seasonal Patterns
#######################################

# Clear period 4 pattern - detected_periods should include 4
query I
SELECT 4 = ANY((ts_analyze_seasonality([10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0])).detected_periods);
----
true

# Clear period 4 pattern - primary_period should be 4
query I
SELECT (ts_analyze_seasonality([10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0])).primary_period;
----
4

#######################################
# Strength Properties
#######################################

# Seasonal strength should be between 0 and 1
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).seasonal_strength >= 0;
----
true

# Trend strength should be between 0 and 1
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).trend_strength >= 0;
----
true

#######################################
# NULL Handling
#######################################

# NULL input should return NULL for detect
query I
SELECT ts_detect_seasonality(NULL) IS NULL;
----
true

# NULL input should return NULL for analyze
query I
SELECT ts_analyze_seasonality(NULL) IS NULL;
----
true
