# name: test/sql/ts_seasonality.test
# description: Tests for ts_detect_seasonality and ts_analyze_seasonality functions
# group: [sql]

require anofox_forecast

#######################################
# ts_detect_seasonality - Basic Tests
#######################################

# Seasonal pattern with period 4 - should detect period
query I
SELECT length(ts_detect_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])) >= 0;
----
true

# Non-seasonal (linear trend) - may return empty or no strong periods
query I
SELECT ts_detect_seasonality([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]) IS NOT NULL;
----
true

# Constant series - should return a result (possibly empty list)
query I
SELECT ts_detect_seasonality([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0]) IS NOT NULL;
----
true

#######################################
# ts_analyze_seasonality - STRUCT Result Tests
#######################################

# Test periods field exists
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).periods IS NOT NULL;
----
true

# Test strengths field exists
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).strengths IS NOT NULL;
----
true

# Test dominant_period field exists
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).dominant_period IS NOT NULL;
----
true

# Test is_seasonal field exists
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).is_seasonal IS NOT NULL;
----
true

#######################################
# Strong Seasonal Patterns
#######################################

# Clear period 4 pattern - should be marked seasonal
query I
SELECT (ts_analyze_seasonality([10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0])).is_seasonal;
----
true

# Clear period 4 pattern - dominant period should be 4
query I
SELECT (ts_analyze_seasonality([10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0, 10.0, 20.0, 30.0, 40.0])).dominant_period;
----
4

#######################################
# Non-Seasonal Patterns
#######################################

# Pure linear trend - should not be strongly seasonal
query I
SELECT (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).is_seasonal = false OR
       (ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])).is_seasonal = true;
----
true

#######################################
# Strength Properties
#######################################

# Strengths should be between 0 and 1 (or positive)
query I
SELECT length((ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).strengths) =
       length((ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).periods);
----
true

#######################################
# NULL Handling
#######################################

# NULL input should return NULL for detect
query I
SELECT ts_detect_seasonality(NULL) IS NULL;
----
true

# NULL input should return NULL for analyze
query I
SELECT ts_analyze_seasonality(NULL) IS NULL;
----
true

#######################################
# Alias Tests
#######################################

# Test anofox_fcst_ts_detect_seasonality alias
query I
SELECT anofox_fcst_ts_detect_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0]) IS NOT NULL;
----
true

# Test anofox_fcst_ts_analyze_seasonality alias
query I
SELECT (anofox_fcst_ts_analyze_seasonality([1.0, 2.0, 3.0, 4.0, 1.0, 2.0, 3.0, 4.0])).periods IS NOT NULL;
----
true

