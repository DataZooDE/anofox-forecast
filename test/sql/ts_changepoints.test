# name: test/sql/ts_changepoints.test
# description: Tests for ts_detect_changepoints table function (C++ API compatible)
# group: [sql]

require anofox_forecast

#######################################
# Internal _ts_detect_changepoints_bocpd Tests
#######################################

# Test returns STRUCT with is_changepoint field
query I
SELECT (_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).is_changepoint IS NOT NULL;
----
true

# Test returns STRUCT with changepoint_probability field
query I
SELECT (_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).changepoint_probability IS NOT NULL;
----
true

# Test returns STRUCT with changepoint_indices field
query I
SELECT (_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).changepoint_indices IS NOT NULL;
----
true

# Test is_changepoint array has same length as input
query I
SELECT length((_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).is_changepoint);
----
8

# Test changepoint_probability array has same length as input
query I
SELECT length((_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).changepoint_probability);
----
8

#######################################
# Constant Series Tests
#######################################

# Constant series - should have no changepoints
query I
SELECT length((_ts_detect_changepoints_bocpd([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0], 250.0, false)).changepoint_indices);
----
0

#######################################
# Boundary Condition Tests (GH#50)
# First/last observations should NOT be artificially marked as changepoints
#######################################

# First observation should NEVER be marked as changepoint (no prior segment exists)
query I
SELECT (_ts_detect_changepoints_bocpd([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0], 250.0, true)).is_changepoint[1];
----
false

# Last observation should NOT be artificially marked as changepoint
query I
SELECT (_ts_detect_changepoints_bocpd([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0], 250.0, true)).is_changepoint[8];
----
false

# Stable series with small random noise - first observation should not be changepoint
query I
SELECT (_ts_detect_changepoints_bocpd([50.1, 50.2, 50.3, 50.1, 50.4, 50.2, 50.3, 50.1], 250.0, true)).is_changepoint[1];
----
false

# Stable series with small random noise - last observation should not be changepoint
query I
SELECT (_ts_detect_changepoints_bocpd([50.1, 50.2, 50.3, 50.1, 50.4, 50.2, 50.3, 50.1], 250.0, true)).is_changepoint[8];
----
false

# Changepoint probability for first observation should be below threshold (< 0.5)
query I
SELECT (_ts_detect_changepoints_bocpd([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0], 250.0, true)).changepoint_probability[1] < 0.5;
----
true

# Changepoint probability for last observation should be below threshold (< 0.5)
query I
SELECT (_ts_detect_changepoints_bocpd([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0], 250.0, true)).changepoint_probability[8] < 0.5;
----
true

# Index 0 should NOT appear in changepoint_indices for stable data
query I
SELECT list_contains((_ts_detect_changepoints_bocpd([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0], 250.0, true)).changepoint_indices, 0::UBIGINT);
----
false

# Last index (n-1) should NOT appear in changepoint_indices for stable data
query I
SELECT list_contains((_ts_detect_changepoints_bocpd([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0], 250.0, true)).changepoint_indices, 7::UBIGINT);
----
false

#######################################
# NULL Handling
#######################################

# NULL input should return NULL
query I
SELECT _ts_detect_changepoints_bocpd(NULL, 250.0, false) IS NULL;
----
true

#######################################
# Table Function API Tests
#######################################

statement ok
CREATE TABLE changepoint_test AS
SELECT ('2023-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS date,
       CASE WHEN i < 5 THEN 1.0 ELSE 10.0 END AS val
FROM generate_series(0, 9) AS t(i);

# Test ts_detect_changepoints table function returns results
query I
SELECT COUNT(*) FROM ts_detect_changepoints('changepoint_test', date, val, MAP(['hazard_lambda'], ['250.0']));
----
10

statement ok
DROP TABLE changepoint_test;
