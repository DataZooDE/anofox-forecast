# name: test/sql/ts_changepoints.test
# description: Tests for ts_detect_changepoints table function (C++ API compatible)
# group: [sql]

require anofox_forecast

#######################################
# Internal _ts_detect_changepoints_bocpd Tests
#######################################

# Test returns STRUCT with is_changepoint field
query I
SELECT (_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).is_changepoint IS NOT NULL;
----
true

# Test returns STRUCT with changepoint_probability field
query I
SELECT (_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).changepoint_probability IS NOT NULL;
----
true

# Test returns STRUCT with changepoint_indices field
query I
SELECT (_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).changepoint_indices IS NOT NULL;
----
true

# Test is_changepoint array has same length as input
query I
SELECT length((_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).is_changepoint);
----
8

# Test changepoint_probability array has same length as input
query I
SELECT length((_ts_detect_changepoints_bocpd([1.0, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0, 10.0], 250.0, false)).changepoint_probability);
----
8

#######################################
# Constant Series Tests
#######################################

# Constant series - should have no changepoints
query I
SELECT length((_ts_detect_changepoints_bocpd([5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0], 250.0, false)).changepoint_indices);
----
0

#######################################
# NULL Handling
#######################################

# NULL input should return NULL
query I
SELECT _ts_detect_changepoints_bocpd(NULL, 250.0, false) IS NULL;
----
true

#######################################
# Table Function API Tests
#######################################

statement ok
CREATE TABLE changepoint_test AS
SELECT ('2023-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS date,
       CASE WHEN i < 5 THEN 1.0 ELSE 10.0 END AS val
FROM generate_series(0, 9) AS t(i);

# Test ts_detect_changepoints table function returns results
query I
SELECT COUNT(*) FROM ts_detect_changepoints('changepoint_test', date, val, MAP(['hazard_lambda'], ['250.0']));
----
10

statement ok
DROP TABLE changepoint_test;
