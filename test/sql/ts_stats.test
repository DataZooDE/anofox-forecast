# name: test/sql/ts_stats.test
# description: Tests for ts_stats time series statistics table function (C++ API compatible)
# group: [sql]

require anofox_forecast

#######################################
# Table Function Tests (C++ API Compatible)
#######################################

# Create test data table
statement ok
CREATE TABLE test_series AS
SELECT 'A' AS id,
       ('2023-01-01'::DATE + (i || ' days')::INTERVAL)::TIMESTAMP AS date,
       (i + 1)::DOUBLE AS value
FROM generate_series(0, 4) AS t(i)
UNION ALL
SELECT 'B' AS id,
       ('2023-01-01'::DATE + (i || ' days')::INTERVAL)::TIMESTAMP AS date,
       (i * 2)::DOUBLE AS value
FROM generate_series(0, 4) AS t(i);

# Test basic ts_stats table function
query II
SELECT id, (stats).length FROM ts_stats('test_series', id, date, value, '1 day') ORDER BY id;
----
A	5
B	5

# Test mean calculation
query IR
SELECT id, (stats).mean FROM ts_stats('test_series', id, date, value, '1 day') ORDER BY id;
----
A	3.0
B	4.0

# Test min/max
query IRR
SELECT id, (stats).min, (stats).max FROM ts_stats('test_series', id, date, value, '1 day') ORDER BY id;
----
A	1.0	5.0
B	0.0	8.0

#######################################
# Internal Scalar Function Tests
#######################################

# Test the internal _ts_stats scalar function (used by table macro)
query I
SELECT (_ts_stats([1.0, 2.0, 3.0, 4.0, 5.0])).length;
----
5

query I
SELECT (_ts_stats([1.0, 2.0, 3.0, 4.0, 5.0])).mean;
----
3.0

query I
SELECT (_ts_stats([1.0, 2.0, 3.0, 4.0, 5.0])).median;
----
3.0

query I
SELECT (_ts_stats([1.0, 2.0, 3.0, 4.0, 5.0])).min;
----
1.0

query I
SELECT (_ts_stats([1.0, 2.0, 3.0, 4.0, 5.0])).max;
----
5.0

query I
SELECT (_ts_stats([1.0, 2.0, 3.0, 4.0, 5.0])).range;
----
4.0

query I
SELECT (_ts_stats([1.0, 2.0, 3.0, 4.0, 5.0])).sum;
----
15.0

# Test n_zeros count
query I
SELECT (_ts_stats([0.0, 1.0, 0.0, 2.0, 0.0])).n_zeros;
----
3

# Test n_positive count
query I
SELECT (_ts_stats([-1.0, 0.0, 1.0, 2.0, 3.0])).n_positive;
----
3

# Test n_negative count
query I
SELECT (_ts_stats([-2.0, -1.0, 0.0, 1.0, 2.0])).n_negative;
----
2

# Test skewness for symmetric distribution (should be near 0)
query I
SELECT ABS((_ts_stats([1.0, 2.0, 3.0, 4.0, 5.0])).skewness) < 0.1;
----
true

# Test autocorrelation lag 1 for trending series (should be positive)
query I
SELECT (_ts_stats([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0])).autocorr_lag1 > 0;
----
true

# Test with single value
query I
SELECT (_ts_stats([5.0])).length;
----
1

# Test with constant series
query I
SELECT (_ts_stats([3.0, 3.0, 3.0, 3.0, 3.0])).variance;
----
0.0

# Test with NULL in array
query I
SELECT (_ts_stats([1.0, NULL, 3.0, NULL, 5.0])).n_nulls;
----
2

# Test NULL input
query I
SELECT _ts_stats(NULL) IS NULL;
----
true
