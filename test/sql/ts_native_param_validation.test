# name: test/sql/ts_native_param_validation.test
# description: Tests for parameter validation in _ts_forecast_native and _ts_cv_forecast_native
#              Verifies explicit error messages for invalid parameters (#177)
# group: [sql]

require anofox_forecast

#######################################
# Setup: test data
#######################################

statement ok
CREATE TABLE param_test_data AS
SELECT
    'G1' AS id,
    ('2024-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS ds,
    10.0 + i * 0.5 + sin(i * 3.14159 / 7) * 3 AS y
FROM generate_series(0, 59) AS t(i)
UNION ALL
SELECT
    'G2' AS id,
    ('2024-01-01'::DATE + (i || ' day')::INTERVAL)::TIMESTAMP AS ds,
    20.0 + i * 0.3 + cos(i * 3.14159 / 7) * 2 AS y
FROM generate_series(0, 59) AS t(i);

statement ok
CREATE TABLE param_test_cv AS
SELECT 1::BIGINT AS fold_id, 'train' AS split, id, ds, y
FROM param_test_data
WHERE ds < '2024-02-15'::TIMESTAMP
UNION ALL
SELECT 1::BIGINT AS fold_id, 'test' AS split, id, ds, y
FROM param_test_data
WHERE ds >= '2024-02-15'::TIMESTAMP AND ds < '2024-02-18'::TIMESTAMP;

#######################################
# Unknown parameter key → error
#######################################

# Typo in param name: 'methd' instead of 'model'
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{'methd': 'ETS'});
----
Unknown parameter

# Multiple unknown keys
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{'foo': '1', 'bar': '2'});
----
Unknown parameter

# Unknown key in CV function
statement error
SELECT * FROM _ts_cv_forecast_native(
    (SELECT fold_id, split, id, ds, y FROM param_test_cv), 'AutoETS', MAP{'methd': 'ETS'});
----
Unknown parameter

#######################################
# Invalid confidence_level → range error
#######################################

# confidence_level = 0 (boundary)
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{'confidence_level': '0.0'});
----
Invalid confidence_level

# confidence_level negative
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{'confidence_level': '-0.5'});
----
Invalid confidence_level

# confidence_level >= 1.0
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{'confidence_level': '1.0'});
----
Invalid confidence_level

# confidence_level way out of range
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{'confidence_level': '5.0'});
----
Invalid confidence_level

# CV function: confidence_level out of range
statement error
SELECT * FROM _ts_cv_forecast_native(
    (SELECT fold_id, split, id, ds, y FROM param_test_cv), 'AutoETS', MAP{'confidence_level': '1.5'});
----
Invalid confidence_level

#######################################
# 'model' param with non-ETS method → error
#######################################

# model param with Naive method
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'Naive', MAP{'model': 'AAA'});
----
only valid when method='ETS'

# model param with AutoMFLES method
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoMFLES', MAP{'model': 'AAA'});
----
only valid when method='ETS'

# CV function: model param with non-ETS method
statement error
SELECT * FROM _ts_cv_forecast_native(
    (SELECT fold_id, split, id, ds, y FROM param_test_cv), 'Holt', MAP{'model': 'ANA'});
----
only valid when method='ETS'

#######################################
# Invalid ETS notation → error with format explanation
#######################################

statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'ETS', MAP{'model': 'XYZ'});
----
Invalid ETS model specification

statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'ETS', MAP{'model': 'AAAAA'});
----
Invalid ETS model specification

#######################################
# Unstable ETS combination → error with alternatives
#######################################

statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'ETS', MAP{'model': 'MAA'});
----
unstable

statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'ETS', MAP{'model': 'MAdA'});
----
unstable

#######################################
# ETS spec is passed through to Rust (no longer silently ignored)
#######################################

# ETS with explicit spec now fits correctly (bugfix: make_timeseries replaces TimeSeriesBuilder)
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'ETS', MAP{'model': 'AAA'});
----
6

# ETS without model spec should fall back to simplified implementation
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'ETS', MAP{});
----
6

#######################################
# seasonal_period with non-seasonal model → error
#######################################

# Naive does not use seasonal_period
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'Naive', MAP{'seasonal_period': '7'});
----
does not use seasonal_period

# SES does not use seasonal_period
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'SES', MAP{'seasonal_period': '7'});
----
does not use seasonal_period

# CrostonClassic does not use seasonal_period
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'CrostonClassic', MAP{'seasonal_period': '52'});
----
does not use seasonal_period

# Theta now accepts seasonal_period (ecfc22f)
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'Theta', MAP{'seasonal_period': '12'});
----
6

# But seasonal models with seasonal_period should work fine
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'SeasonalNaive', MAP{'seasonal_period': '7'});
----
6

query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'HoltWinters', MAP{'seasonal_period': '7'});
----
6

#######################################
# Valid params still work correctly
#######################################

# Valid confidence_level
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{'confidence_level': '0.95'});
----
6

# Empty MAP is fine
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{});
----
6

#######################################
# SMA 'window' parameter
#######################################

# SMA with valid window should succeed
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'SMA', MAP{'window': '12'});
----
6

# SMA with negative window → error
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'SMA', MAP{'window': '-1'});
----
must be a positive integer

# 'window' with non-SMA method → error
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'Naive', MAP{'window': '5'});
----
only valid when method='SMA'

#######################################
# 'seasonal_periods' parameter
#######################################

# AutoMFLES with seasonal_periods should succeed
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoMFLES', MAP{'seasonal_periods': '[7, 14]'});
----
6

# seasonal_periods with non-multi-seasonal model → error
statement error
SELECT * FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'Naive', MAP{'seasonal_periods': '[7]'});
----
only valid for multi-seasonal models

# seasonal_periods overrides seasonal_period for multi-seasonal models
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoMFLES', MAP{'seasonal_period': '7', 'seasonal_periods': '[7, 14]'});
----
6

###############################################################################
# PARAMETER ACCEPTANCE REGRESSION GUARD
#
# Every MAP{} parameter supported by _ts_forecast_native and
# _ts_cv_forecast_native MUST have a positive acceptance test below.
# When adding a new parameter:
#   1. Add it to ValidateParamKeys in ts_forecast_native.cpp AND ts_cv_forecast_native.cpp
#   2. Add a positive test here for BOTH _ts_forecast_native AND _ts_cv_forecast_native
#   3. Add negative tests (wrong model, bad value) in the sections above
#
# Documented params NOT yet wired through MAP{}:
#   alpha, beta, gamma, theta, p, d, q, P, D, Q, s, alpha_d, alpha_p, use_box_cox
###############################################################################

# --- confidence_level: accepted by all models ---
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{'confidence_level': '0.80'});
----
6

query I
SELECT COUNT(*) FROM _ts_cv_forecast_native(
    (SELECT fold_id, split, id, ds, y FROM param_test_cv), 'AutoETS', MAP{'confidence_level': '0.80'});
----
6

# --- model (ETS spec): accepted only with method='ETS' ---
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'ETS', MAP{'model': 'ANA'});
----
6

query I
SELECT COUNT(*) FROM _ts_cv_forecast_native(
    (SELECT fold_id, split, id, ds, y FROM param_test_cv), 'ETS', MAP{'model': 'ANA'});
----
6

# --- seasonal_period: accepted by seasonal models ---
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoETS', MAP{'seasonal_period': '7'});
----
6

query I
SELECT COUNT(*) FROM _ts_cv_forecast_native(
    (SELECT fold_id, split, id, ds, y FROM param_test_cv), 'AutoETS', MAP{'seasonal_period': '7'});
----
6

# --- window: accepted only with method='SMA' ---
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'SMA', MAP{'window': '5'});
----
6

query I
SELECT COUNT(*) FROM _ts_cv_forecast_native(
    (SELECT fold_id, split, id, ds, y FROM param_test_cv), 'SMA', MAP{'window': '5'});
----
6

# --- seasonal_periods: accepted only with multi-seasonal models ---
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoMFLES', MAP{'seasonal_periods': '[7]'});
----
6

query I
SELECT COUNT(*) FROM _ts_cv_forecast_native(
    (SELECT fold_id, split, id, ds, y FROM param_test_cv), 'AutoMFLES', MAP{'seasonal_periods': '[7]'});
----
6

# --- seasonal_periods with other multi-seasonal models ---
query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'MSTL', MAP{'seasonal_periods': '[7]'});
----
6

query I
SELECT COUNT(*) FROM _ts_forecast_native(
    (SELECT id, ds, y FROM param_test_data), 3, '1d', 'AutoTBATS', MAP{'seasonal_periods': '[7]'});
----
6

#######################################
# Cleanup
#######################################

statement ok
DROP TABLE param_test_data;

statement ok
DROP TABLE param_test_cv;
